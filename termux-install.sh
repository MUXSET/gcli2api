#!/bin/bash# 避免交互式提�?export DEBIAN_FRONTEND=noninteractiveif [ "$(whoami)" = "root" ]; then    echo "检测到root用户，正在退�?.."    exitfiecho "检查Termux镜像源配�?.."# 检查当前镜像源是否已经是Cloudflare镜像target_mirror="https://packages-cf.termux.dev/apt/termux-main"fallback_mirror="https://packages.termux.dev/apt/termux-main"if [ -f "$PREFIX/etc/apt/sources.list" ] && grep -q "$target_mirror" "$PREFIX/etc/apt/sources.list"; then    echo "�?镜像源已经配置为Cloudflare镜像，跳过修�?else    echo "正在设置Termux镜像为Cloudflare镜像..."        # 备份原始sources.list文件    if [ -f "$PREFIX/etc/apt/sources.list" ]; then        echo "备份原始sources.list文件..."        cp "$PREFIX/etc/apt/sources.list" "$PREFIX/etc/apt/sources.list.backup.$(date +%s)"    fi        # 写入新的镜像�?    echo "写入新的镜像源配�?.."    cat > "$PREFIX/etc/apt/sources.list" << 'EOF'# Cloudflare镜像�?deb https://packages-cf.termux.dev/apt/termux-main stable mainEOF        echo "�?镜像源已更新�? $target_mirror"fiensure_dpkg_ready() {    echo "检查并修复 dpkg/apt 状�?.."    # 等待可能存在�?apt/dpkg 进程结束    if pgrep -f "apt|dpkg" >/dev/null 2>&1; then        echo "检测到 apt/dpkg 正在运行，等待其结束..."        while pgrep -f "apt|dpkg" >/dev/null 2>&1; do sleep 1; done    fi    # 清理可能残留的锁（若无进程）    for f in "$PREFIX/var/lib/dpkg/lock" \             "$PREFIX/var/lib/apt/lists/lock" \             "$PREFIX/var/cache/apt/archives/lock"; do        [ -e "$f" ] && rm -f "$f"    done    # 尝试继续未完成的配置    dpkg --configure -a || true}# 更新包列表并检查错�?echo "正在更新包列�?.."ensure_dpkg_readyapt_output=$(apt update 2>&1)if [ $? -ne 0 ]; then    if echo "$apt_output" | grep -qi "is not signed"; then        echo "⚠️ 检测到仓库未签名，尝试切换到官方镜像并修复 keyring..."        # 切换到官方镜�?        sed -i "s#${target_mirror}#${fallback_mirror}#g" "$PREFIX/etc/apt/sources.list" || true        # 清理列表与锁        rm -rf "$PREFIX/var/lib/apt/lists/"* || true        rm -f "$PREFIX/var/lib/dpkg/lock" "$PREFIX/var/lib/apt/lists/lock" "$PREFIX/var/cache/apt/archives/lock" || true        # 重新安装 termux-keyring（若已安装则强制重装�?        apt-get install --reinstall -y termux-keyring || true        # 再次更新        ensure_dpkg_ready        apt update    else        echo "apt update 失败，错误信息："        echo "$apt_output" | head -20        exit 1    fielse    echo "$apt_output"fiecho "�?Termux镜像设置完成�?echo "📁 原始配置已备份到: $PREFIX/etc/apt/sources.list.backup.*"echo "🔄 如需恢复原始镜像，可以运�?"echo "   cp \$PREFIX/etc/apt/sources.list.backup.* \$PREFIX/etc/apt/sources.list && apt update"# 检查是否需要更新包管理器和安装软件need_update=falsepackages_to_install=""# 检�?uv 是否已安�?if ! command -v uv &> /dev/null; then    need_update=true    packages_to_install="$packages_to_install uv"fi# 检�?python 是否已安�?if ! command -v python &> /dev/null; then    need_update=true    packages_to_install="$packages_to_install python"fi# 检�?nodejs 是否已安�?if ! command -v node &> /dev/null; then    need_update=true    packages_to_install="$packages_to_install nodejs"fi# 检�?git 是否已安�?if ! command -v git &> /dev/null; then    need_update=true    packages_to_install="$packages_to_install git"fi# 如果需要安装软件，则更新包管理器并安装if [ "$need_update" = true ]; then    echo "正在更新包管理器..."    ensure_dpkg_ready    echo "正在安装缺失的软件包: $packages_to_install"    pkg install $packages_to_install -yelse    echo "所需软件包已全部安装，跳过更新和安装步骤"fi# 检�?pm2 是否已安�?if ! command -v pm2 &> /dev/null; then    echo "正在安装 pm2..."    npm install pm2 -gelse    echo "pm2 已安装，跳过安装"fi# 项目目录处理逻辑if [ -f "./web.py" ]; then    # Already in target directory; skip clone and cd    echo "已在目标目录中，跳过克隆操作"elif [ -f "./gcli2api/web.py" ]; then    echo "进入已存在的 gcli2api 目录"    cd ./gcli2apielse    echo "克隆项目仓库..."    git clone https://github.com/MUXSET/gcli2api.git    cd ./gcli2apifiecho "强制同步项目代码，忽略本地修�?.."git fetch --allgit reset --hard origin/$(git rev-parse --abbrev-ref HEAD)echo "初始�?uv 环境..."uv initecho "安装 Python 依赖..."uv add -r requirements-termux.txtecho "激活虚拟环境并启动服务..."source .venv/bin/activatepm2 start .venv/bin/python --name web -- web.pycd ..echo "�?安装完成！服务已启动�?