# 多用户与权限管理系统功能说明

本项目新增了完整的 **多用户支持 (Multi-User)** 和 **基于角色的访问控制 (RBAC)** 系统。本文档详细介绍了这些新功能的特性和使用方法。

## 1. 系统概述

新的权限系统旨在解决多人共享使用时的安全和管理问题。它引入了账户体系，将用户分为 **管理员 (Admin)** 和 **普通用户 (User)**，并支持 **凭证隔离**，确保用户只能使用自己的资源（或在允许的情况下共享公共资源）。

---

## 2. 角色说明

### 👑 管理员 (Admin)
- **默认账户**: 系统初始化时会自动创建默认管理员账户。
    - 用户名: `admin`
    - 初始密码: `admin` (建议首次登录后立即修改)
- **权限**:
    - **最高控制权**: 访问所有系统配置、环境变量、批量上传等敏感功能。
    - **用户管理**: 可以查看、删除普通用户，重置用户密码，查看用户凭证和用量。
    - **全局配置**: 可以开启/关闭“凭证隔离模式”等全局开关。
    - **全量凭证使用**: 可以使用系统中上传的所有凭证文件。

### 👤 普通用户 (User)
- **注册**: 任何人都可以通过注册页面创建普通账户。
- **权限**:
    - **受限访问**: 仅能访问“控制面板”和“个人中心”。
    - **配置隐藏**: 无法查看系统环境变量、敏感配置或上传批量凭证（除非特定开放）。
    - **个人凭证**: 可以上传属于自己的 Google 凭证文件。
    - **独立 API Key**: 拥有独立的 `sk-gcli-...` API Key，用于调用 API。

---

## 3. 核心功能详解

### 3.1 注册与登录
- **注册**: 访问首页点击“注册”，输入用户名和密码即可创建账户。新账户默认为普通用户角色。
- **登录**: 登录后，系统会根据角色自动展示相应的 UI 界面。
    - **管理员**: 显示完整的标签页（配置、用量、环境变量、批量上传等）。
    - **普通用户**: 仅显示“控制面板”和“个人中心”。

### 3.2 个人中心 (Personal Center)
位于控制面板的“个人中心”标签页，提供以下功能：
- **修改密码**: 用户可以自行修改登录密码。
- **API Key 管理**:
    - 显示当前用户的专属 API Key (`sk-gcli-...`)。
    - 支持一键复制和重新生成 Key。
- **当前角色**: 显示当前用户的权限等级。
- **API 使用统计**: 显示当前用户 **实际发起** 的 API 调用总数（不同于凭证的使用次数）。

### 3.3 管理后台 (Admin Panel)
管理员可通过个人中心的“进入管理后台”按钮访问独立管理界面：
- **用户列表**:查看所有注册用户。
- **用户操作**:
    - **改密**: 强制重置指定用户的密码（应对忘记密码的情况）。
    - **凭证**: 查看指定用户上传了哪些凭证文件。
    - **统计**: 查看指定用户贡献的凭证被调用的总次数。
    - **删除**: 永久删除违规用户（默认 admin 账户不可删除）。

---

## 4. 凭证隔离模式 (Credential Isolation Mode)

这是一个增强安全性的核心开关，位于 **配置 (Config)** 标签页中（仅管理员可见）。

- **⛔ 开启隔离 (Isolation ON)**:
    - **严格模式**: 用户调用 API 时，系统 **只会** 使用 **该用户自己上传** 的凭证文件。
    - 如果用户没有上传凭证，API 调用将失败，提示无可用凭证。
    - 防止普通用户消耗管理员或其他用户的配额。

- **🌍 关闭隔离 (Isolation OFF) [默认]**:
    - **共享模式**: 所有用户共享凭证池。
    - 普通用户可以调用 API，系统会从全局可用的凭证中轮询选择一个（包括管理员上传的凭证）。
    - 适合小型团队或家庭共享场景。

---

## 5. API 调用变化

### 5.1 认证方式
现在推荐使用标准的 OpenAI 格式认证：
- **API Key**: 使用个人中心生成的 `sk-gcli-xxxx`。
- **HTTP Header**: `Authorization: Bearer sk-gcli-xxxx`

*(注：旧版的全局密码 `pwd` 认证已被移除，请尽快切换到 API Key)*

### 5.2 用量计费逻辑
系统现在维护两套统计数据，确保计费准确：
1.  **用户实际消耗 (User Actual Calls)**:
    - 统计 **谁** 发起了请求。
    - 无论使用哪个凭证，这笔调用都算在发起人的头上。
    - 在管理后台的“用户列表”中可以查看此数据。

2.  **凭证消耗 (Credential Usage)**:
    - 统计 **哪个文件** 被使用了。
    - 无论谁发起的请求，只要用了这个文件，计数就加 1。
    - 用于监控 Google 账号的配额限制。
