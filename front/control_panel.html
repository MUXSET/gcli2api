<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCLI2API æ§åˆ¶é¢æ¿</title>
    <style>
        :root {
            --primary: #4F46E5;
            /* Indigo 600 */
            --primary-hover: #4338CA;
            /* Indigo 700 */
            --secondary: #6B7280;
            /* Gray 500 */
            --bg: #F3F4F6;
            /* Gray 100 */
            --surface: #FFFFFF;
            --text-main: #111827;
            /* Gray 900 */
            --text-secondary: #4B5563;
            /* Gray 600 */
            --border: #E5E7EB;
            /* Gray 200 */
            --success: #10B981;
            /* Emerald 500 */
            --error: #EF4444;
            /* Red 500 */
            --warning: #F59E0B;
            /* Amber 500 */
            --info: #3B82F6;
            /* Blue 500 */
            --radius: 0.75rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-main: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --transition: all 0.2s ease;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .flex.justify-between.items-center.mb-8 {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .flex.gap-4 {
                flex-wrap: wrap;
                width: 100%;
            }

            .flex.gap-4>* {
                flex: 1;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }

            .tabs {
                padding: 0.25rem;
                margin-bottom: 1.5rem;
            }

            .tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8125rem;
            }

            .card {
                padding: 1.25rem;
            }

            .btn {
                width: 100%;
                padding: 0.625rem;
            }

            /* Adjust button groups in cards */
            .flex.gap-4 .btn {
                flex: 1 1 auto;
                /* Allow buttons to grow/shrink */
                min-width: 0;
                /* Prevent overflow */
            }

            /* Fix specific button groups that shouldn't wrap awkwardly */
            .flex.justify-between .flex.gap-2 {
                width: 100%;
                margin-top: 0.5rem;
            }

            /* Credential List Items */
            .list-item>div.flex {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .list-item .cred-actions {
                flex-wrap: wrap;
                margin-top: 0.5rem;
            }

            .list-item .cred-actions .btn {
                width: auto;
                flex: 1;
            }
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Helpers */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        /* Typography */
        h1 {
            font-size: 1.875rem;
            font-weight: 800;
            color: var(--text-main);
            margin: 0 0 1.5rem 0;
            letter-spacing: -0.025em;
        }

        h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-main);
            margin: 0 0 1rem 0;
        }

        h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-main);
            margin: 0 0 0.75rem 0;
        }

        /* Cards */
        .card {
            background-color: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
            background-color: var(--primary);
            color: white;
            text-decoration: none;
            line-height: 1.25rem;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-outline-danger {
            background-color: transparent;
            border-color: var(--error);
            color: var(--error);
        }

        .btn-outline-danger:hover {
            background-color: #FEF2F2;
        }

        .btn-secondary {
            background-color: white;
            border-color: var(--border);
            color: var(--text-main);
        }

        .btn-secondary:hover {
            background-color: #F9FAFB;
            border-color: #D1D5DB;
        }

        /* Inputs */
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="url"],
        select {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background-color: #F9FAFB;
            font-size: 0.875rem;
            color: var(--text-main);
            transition: var(--transition);
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Login Form */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 400px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .tab {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            white-space: nowrap;
            transition: var(--transition);
        }

        .tab:hover {
            background-color: #EEF2FF;
            color: var(--primary);
        }

        .tab.active {
            background-color: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Status Messages */
        #statusSection {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
        }

        .status-msg {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--info);
            font-size: 0.875rem;
            pointer-events: auto;
            animation: slideIn 0.3s ease;
        }

        .status-msg.success {
            border-color: var(--success);
        }

        .status-msg.error {
            border-color: var(--error);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background-color: #D1FAE5;
            color: #065F46;
        }

        .badge-warning {
            background-color: #FEF3C7;
            color: #92400E;
        }

        .badge-error {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        .badge-info {
            background-color: #DBEAFE;
            color: #1E40AF;
        }

        /* File List & Creds */
        .list-item {
            background: #F9FAFB;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
        }

        .list-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
            background: white;
        }

        .cred-actions {
            display: flex;
            gap: 0.5rem;
        }

        .cred-actions button {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: #F9FAFB;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #EEF2FF;
        }

        /* Config Groups */
        .config-group {
            background: #F9FAFB;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .config-group label {
            display: block;
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text-main);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .stat-val {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Loading */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        pre {
            background: #1F2937;
            color: #F3F4F6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: ui-monospace, monospace;
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginSection" class="login-container">
        <div class="login-box">
            <h1 class="text-center" style="text-align: center; margin-bottom: 2rem;" id="authTitle">æ¬¢è¿å›æ¥</h1>
            <p class="text-secondary" style="text-align: center; margin-bottom: 2rem;" id="authSubtitle">è¯·ç™»å½•ä»¥ç»§ç»­ç®¡ç†æ‚¨çš„æœåŠ¡
            </p>

            <div class="mb-4">
                <input type="text" id="loginUsername" placeholder="ç”¨æˆ·å" />
            </div>
            <div class="mb-4">
                <input type="password" id="loginPassword" placeholder="å¯†ç " onkeypress="handlePasswordEnter(event)" />
            </div>
            <button class="btn" style="width: 100%; height: 3rem; font-size: 1rem;" id="authBtn"
                onclick="handleAuth()">ç™»å½•</button>

            <div class="mt-4" style="text-align: center;">
                <a href="#" class="text-sm" style="color: var(--primary); text-decoration: none;" id="authToggleLink"
                    onclick="toggleAuthMode()">æ³¨å†Œæ–°è´¦å·</a>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainSection" class="container hidden">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 style="margin: 0; font-size: 1.5rem;">æ§åˆ¶å°</h1>
                <p class="text-secondary text-sm" style="margin: 0.25rem 0 0 0;">ç®¡ç†æ‚¨çš„ API å‡­è¯ä¸é…ç½®</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-sm text-secondary">
                    <span id="profileUsername" class="font-bold text-main" style="color: var(--text-main);">User</span>
                    <span id="profileRoleBadge" class="badge badge-info" style="margin-left: 0.5rem;">Role</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="padding: 0.25rem 0.75rem;">é€€å‡º</button>
                <a href="/admin" id="adminPanelLink" class="btn btn-secondary hidden"
                    style="padding: 0.25rem 0.75rem; text-decoration: none;">åå°ç®¡ç†</a>
            </div>
        </div>

        <!-- System Announcement -->
        <div id="systemAnnouncement" class="status-msg hidden mb-4"
            style="position: static; width: auto; border-left: 4px solid var(--info); animation: none;">
            <strong>ğŸ“¢ å…¬å‘Šï¼š</strong> <span id="announcementText"></span>
        </div>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab active" data-tab="oauth" onclick="switchTab('oauth')">OAuth è®¤è¯</button>
            <button class="tab" data-tab="upload" onclick="switchTab('upload')">ä¸Šä¼ å‡­è¯</button>
            <button class="tab" data-tab="envload" onclick="switchTab('envload')">ç¯å¢ƒå˜é‡</button>
            <button class="tab" data-tab="manage" onclick="switchTab('manage')">å‡­è¯ç®¡ç†</button>
            <button class="tab" data-tab="usage" onclick="switchTab('usage')">ä½¿ç”¨ç»Ÿè®¡</button>
            <button class="tab" data-tab="config" onclick="switchTab('config')">ç³»ç»Ÿé…ç½®</button>
            <button class="tab" data-tab="profile" onclick="switchTab('profile')">ä¸ªäººä¸­å¿ƒ</button>
            <button class="tab" data-tab="logs" onclick="switchTab('logs')">å®æ—¶æ—¥å¿—</button>
        </div>

        <!-- Content -->
        <div class="card" style="min-height: 500px;">

            <!-- OAuth Tab -->
            <div id="oauthTab" class="tab-content active">
                <div class="flex justify-between items-center mb-4">
                    <h3>OAuth æˆæƒ</h3>
                    <div class="badge badge-success">è‡ªåŠ¨å¯ç”¨ API æœåŠ¡</div>
                </div>
                <p class="text-secondary mb-4">é€šè¿‡ Google OAuth å®‰å…¨åœ°æˆæƒæ‚¨çš„åº”ç”¨è®¿é—® Gemini APIã€‚</p>

                <!-- Project ID Config -->
                <div class="config-group">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleProjectIdSection()"
                        style="cursor: pointer;">
                        <span class="font-bold">âœ¨ é«˜çº§ï¼šè‡ªå®šä¹‰ Project ID</span>
                        <span id="projectIdToggleIcon">â–¼</span>
                    </div>
                    <div id="projectIdSection" class="hidden mt-4 pt-4 border-t"
                        style="border-top-color: var(--border);">
                        <label>Google Cloud Project ID (å¯é€‰)</label>
                        <input type="text" id="projectId" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨æ£€æµ‹..." />
                        <p class="text-sm text-secondary mt-2">å¦‚æœä¸ç¡®å®šï¼Œè¯·ä¿æŒä¸ºç©ºï¼Œç³»ç»Ÿå°†å°è¯•è‡ªåŠ¨æ£€æµ‹ã€‚</p>
                    </div>
                </div>

                <!-- Batch Mode -->
                <div class="bs-callout"
                    style="background: #F0FDF4; border: 1px solid #BBF7D0; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="getAllProjectsCreds"
                            style="width: 1.25rem; height: 1.25rem; accent-color: var(--success);"
                            onchange="handleGetAllProjectsChange()">
                        <label for="getAllProjectsCreds" class="font-bold"
                            style="color: #15803D; cursor: pointer;">å¯ç”¨æ‰¹é‡å¹¶å‘è®¤è¯æ¨¡å¼</label>
                    </div>
                    <div id="allProjectsNote" class="hidden mt-2 text-sm" style="color: #166534; margin-left: 2rem;">
                        æˆæƒåå°†è‡ªåŠ¨æ‰«æå¹¶ä¸ºå½“å‰è´¦å·ä¸‹æ‰€æœ‰å¯ç”¨é¡¹ç›®ç”Ÿæˆå‡­è¯ã€‚
                    </div>
                </div>

                <div class="mb-4">
                    <button class="btn" id="getAuthBtn" onclick="startAuth()"
                        style="height: 3rem; padding: 0 2rem; font-size: 1rem;">è·å–è®¤è¯é“¾æ¥</button>
                </div>

                <!-- Auth Result Section -->
                <div id="authUrlSection" class="hidden animate-fade-in">
                    <div class="config-group">
                        <label>è®¤è¯é“¾æ¥</label>
                        <div
                            style="background: white; padding: 1rem; border: 1px solid var(--border); border-radius: 0.5rem; margin-bottom: 1rem; word-break: break-all;">
                            <a id="authUrl" href="#" target="_blank"
                                style="color: var(--primary); font-weight: 500;">ç‚¹å‡»æ­¤å¤„æ‰“å¼€æˆæƒé¡µé¢</a>
                        </div>
                        <div class="text-sm text-secondary">
                            è¯·åœ¨æ–°çª—å£ä¸­å®Œæˆæˆæƒï¼Œç„¶åå¤åˆ¶å›è°ƒåœ°å€æˆ–ç­‰å¾…è‡ªåŠ¨è·³è½¬ã€‚
                        </div>
                    </div>

                    <!-- Callback URL Manual Input -->
                    <div class="config-group">
                        <div class="flex justify-between items-center cursor-pointer"
                            onclick="toggleCallbackUrlSection()" style="cursor: pointer;">
                            <span class="font-bold text-info" style="color: var(--info);">ğŸ“¡ æ— æ³•è‡ªåŠ¨è·³è½¬ï¼Ÿæ‰‹åŠ¨è¾“å…¥å›è°ƒ URL</span>
                            <span id="callbackUrlToggleIcon">â–¼</span>
                        </div>
                        <div id="callbackUrlSection" class="hidden mt-4">
                            <input type="url" id="callbackUrlInput" placeholder="ç²˜è´´ http://localhost:8080/... å®Œæ•´å›è°ƒé“¾æ¥"
                                class="mb-4" />
                            <button class="btn" onclick="processCallbackUrl()"
                                style="background-color: var(--success); border-color: var(--success);">éªŒè¯å›è°ƒé“¾æ¥</button>
                        </div>
                    </div>

                    <button class="btn" id="getCredsBtn" onclick="getCredentials()">è·å–å‡­è¯æ–‡ä»¶</button>
                </div>

                <div id="credentialsSection" class="hidden mt-4">
                    <h4>è®¤è¯ç»“æœ</h4>
                    <pre id="credentialsContent"></pre>
                </div>
            </div>

            <!-- Upload Tab -->
            <div id="uploadTab" class="tab-content">
                <h3>æ‰¹é‡ä¸Šä¼ </h3>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--primary);">â˜ï¸</div>
                    <h4 style="margin: 0;">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</h4>
                    <p class="text-secondary text-sm">æ”¯æŒ .json å‡­è¯æ–‡ä»¶ æˆ– .zip å‹ç¼©åŒ…</p>
                </div>
                <input type="file" id="fileInput" multiple accept=".json,.zip" class="hidden"
                    onchange="handleFileSelect(event)" />

                <div id="fileListSection" class="hidden mt-4">
                    <h4>å¾…ä¸Šä¼ æ–‡ä»¶</h4>
                    <div id="fileList"></div>
                    <div class="flex gap-4 mt-4">
                        <button class="btn" onclick="uploadFiles()">ç¡®è®¤ä¸Šä¼ </button>
                        <button class="btn btn-secondary" onclick="clearFiles()">æ¸…ç©º</button>
                    </div>
                </div>

                <div id="uploadProgressSection" class="hidden mt-4">
                    <div style="background: var(--bg); height: 0.5rem; border-radius: 999px; overflow: hidden;">
                        <div id="progressFill"
                            style="background: var(--success); width: 0%; height: 100%; transition: width 0.3s;"></div>
                    </div>
                    <div class="text-right text-sm text-secondary mt-1" id="progressText">0%</div>
                </div>
            </div>

            <!-- Env Load Tab -->
            <div id="envloadTab" class="tab-content">
                <h3>ç¯å¢ƒå˜é‡å¯¼å…¥</h3>
                <div id="envStatusSection" class="config-group">
                    <div id="envStatusLoading" class="loading-spinner"></div>
                    <div id="envStatusContent" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h4 style="margin: 0;">å½“å‰çŠ¶æ€</h4>
                            <span id="autoLoadStatus" class="badge">Checking...</span>
                        </div>
                        <div class="mb-4">
                            <label>å·²æ£€æµ‹åˆ°çš„å˜é‡</label>
                            <pre id="envVarsList" style="margin-top: 0.5rem;">None</pre>
                        </div>
                        <div>
                            <label>å·²å¯¼å…¥æ–‡ä»¶æ•°: <span id="envFilesCount" class="font-bold text-main">0</span></label>
                            <div id="envFilesList" class="text-sm text-secondary mt-2 font-mono"></div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button class="btn" onclick="checkEnvCredsStatus()">åˆ·æ–°çŠ¶æ€</button>
                    <button class="btn" onclick="loadEnvCredentials()">æ‰§è¡Œå¯¼å…¥</button>
                    <button class="btn btn-outline-danger" onclick="clearEnvCredentials()">æ¸…é™¤å¯¼å…¥</button>
                </div>
            </div>

            <!-- Manage Tab -->
            <div id="manageTab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h3>å‡­è¯åˆ—è¡¨</h3>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary" onclick="refreshCredsStatus()">ğŸ”„ åˆ·æ–°</button>
                        <button class="btn" onclick="downloadAllCreds()">ğŸ“¥ æ‰“åŒ…ä¸‹è½½</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-val" id="statTotal">0</span>
                        <span class="stat-label">æ€»æ–‡ä»¶</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-val" style="color: var(--success);" id="statNormal">0</span>
                        <span class="stat-label">æ­£å¸¸</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-val" style="color: var(--secondary);" id="statDisabled">0</span>
                        <span class="stat-label">å·²ç¦ç”¨</span>
                    </div>
                </div>

                <div class="config-group">
                    <div class="flex items-center justify-between mb-4">
                        <h4 style="margin: 0;">æ‰¹é‡æ“ä½œ</h4>
                        <span id="selectedCount" class="text-sm font-bold text-primary">å·²é€‰ 0 é¡¹</span>
                    </div>
                    <div class="flex gap-2 flex-wrap items-center">
                        <div class="flex items-center mr-4">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"
                                style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;">
                            <label for="selectAllCheckbox" style="margin: 0;">å…¨é€‰</label>
                        </div>
                        <button class="btn" id="batchEnableBtn" onclick="batchAction('enable')" disabled>å¯ç”¨</button>
                        <button class="btn btn-secondary" id="batchDisableBtn" onclick="batchAction('disable')"
                            disabled>ç¦ç”¨</button>
                        <button class="btn btn-outline-danger" id="batchDeleteBtn" onclick="batchAction('delete')"
                            disabled>åˆ é™¤</button>
                        <button class="btn btn-secondary" onclick="refreshAllEmails()">åˆ·æ–°é‚®ç®±</button>
                    </div>
                </div>

                <div class="flex gap-4 mb-4 flex-wrap">
                    <select id="statusFilter" onchange="applyFilters()" style="width: auto;">
                        <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="normal">æ­£å¸¸</option>
                        <option value="disabled">ç¦ç”¨</option>
                    </select>
                    <select id="errorCodeFilter" onchange="applyFilters()" style="width: auto;">
                        <option value="all">æ‰€æœ‰é”™è¯¯ç </option>
                        <option value="no-errors">æ— é”™è¯¯</option>
                        <option value="has-errors">æœ‰é”™è¯¯</option>
                    </select>
                    <select id="pageSizeSelect" onchange="changePageSize()" style="width: auto;">
                        <option value="20">20 / é¡µ</option>
                        <option value="50">50 / é¡µ</option>
                        <option value="100">100 / é¡µ</option>
                    </select>
                    <div id="errorCodeBadges" class="flex gap-2 items-center"></div>
                </div>

                <div id="credsListSection">
                    <div id="credsLoading" class="loading-spinner"></div>
                    <div id="credsList"></div>
                    <div id="paginationContainer" class="flex justify-center items-center gap-4 mt-8 hidden">
                        <button class="btn btn-secondary" id="prevPageBtn" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
                        <span id="paginationInfo" class="text-secondary text-sm"></span>
                        <button class="btn btn-secondary" id="nextPageBtn" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>

            <!-- Usage Tab -->
            <div id="usageTab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h3>ä½¿ç”¨ç»Ÿè®¡</h3>
                    <button class="btn" onclick="refreshUsageStats()">åˆ·æ–°æ•°æ®</button>
                </div>

                <div class="stats-grid" id="usageStatsContainer">
                    <div class="stat-card">
                        <span class="stat-val" id="totalApiCalls">0</span>
                        <span class="stat-label">24H æ€»è°ƒç”¨</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-val" style="color: var(--warning);" id="activeFilesCount">0</span>
                        <span class="stat-label">æ´»è·ƒæ–‡ä»¶</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-val" style="color: var(--info);" id="avgCallsPerFile">0</span>
                        <span class="stat-label">å¹³å‡è°ƒç”¨/æ–‡ä»¶</span>
                    </div>
                </div>

                <div id="usageListSection">
                    <div id="usageLoading" class="loading-spinner"></div>
                    <div id="usageList" class="stats-grid"
                        style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));"></div>
                </div>
            </div>

            <!-- Config Tab -->
            <div id="configTab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h3>ç³»ç»Ÿé…ç½®</h3>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary" onclick="loadConfig()">é‡ç½®</button>
                        <button class="btn" onclick="saveConfig()">ä¿å­˜</button>
                    </div>
                </div>
                <div id="configLoading" class="loading-spinner"></div>
                <div id="configForm" class="hidden">
                    <div class="config-group">
                        <h4>æœåŠ¡ç›‘å¬</h4>
                        <div class="flex gap-4">
                            <div style="flex: 1;"><label>Host</label><input type="text" id="host" /></div>
                            <div style="flex: 1;"><label>Port</label><input type="number" id="port" /></div>
                        </div>
                    </div>

                    <div class="config-group">
                        <h4>åŸºç¡€è®¾ç½®</h4>
                        <div class="mb-4"><label>å‡­è¯ç›®å½•</label><input type="text" id="credentialsDir" /></div>
                        <div><label>ä»£ç†æœåŠ¡å™¨ (HTTP/SOCKS)</label><input type="text" id="proxy"
                                placeholder="http://... or socks5://..." /></div>
                    </div>

                    <div class="config-group">
                        <div class="flex justify-between items-center mb-4">
                            <h4 style="margin: 0;">API ç«¯ç‚¹</h4>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;"
                                    onclick="useMirrorUrls()">ä½¿ç”¨é•œåƒ</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;"
                                    onclick="restoreOfficialUrls()">æ¢å¤å®˜æ–¹</button>
                            </div>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div><label>Code Assist</label><input type="text" id="codeAssistEndpoint" /></div>
                            <div><label>OAuth Proxy</label><input type="text" id="oauthProxyUrl" /></div>
                            <div><label>Google APIs</label><input type="text" id="googleapisProxyUrl" /></div>
                            <div><label>Resource Manager API</label><input type="text" id="resourceManagerApiUrl" />
                            </div>
                            <div><label>Service Usage API</label><input type="text" id="serviceUsageApiUrl" /></div>
                        </div>
                    </div>

                    <div class="config-group">
                        <h4>ç­–ç•¥æ§åˆ¶</h4>
                        <div class="mb-4 flex items-center gap-2">
                            <input type="checkbox" id="autoBanEnabled" style="width: auto;">
                            <label for="autoBanEnabled" style="margin: 0;">å¯ç”¨è‡ªåŠ¨å°ç¦ (Auto Ban)</label>
                        </div>
                        <div class="mb-4">
                            <label>è§¦å‘å°ç¦é”™è¯¯ç </label>
                            <input type="text" id="autoBanErrorCodes" placeholder="400, 403" />
                        </div>
                        <div class="flex gap-4 mb-4">
                            <div style="flex:1;"><label>è½®æ¢é˜ˆå€¼ (Calls)</label><input type="number"
                                    id="callsPerRotation" /></div>
                            <div style="flex:1;"><label>æŠ—æˆªæ–­é‡è¯• (Attempts)</label><input type="number"
                                    id="antiTruncationMaxAttempts" /></div>
                        </div>
                        <div class="mb-2 flex items-center gap-2">
                            <input type="checkbox" id="compatibilityModeEnabled" style="width: auto;">
                            <label for="compatibilityModeEnabled" style="margin: 0;">OpenAI å…¼å®¹æ¨¡å¼ (Flatten System
                                Prompt)</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="returnThoughtsToFrontend" style="width: auto;">
                            <label for="returnThoughtsToFrontend" style="margin: 0;">è¿”å›æ€ç»´é“¾ (Thinking Process)</label>
                        </div>

                        <!-- 429 Retry Configuration -->
                        <div class="mt-4 border-t pt-4" style="border-top-color: var(--border);">
                            <label class="font-bold mb-2 block">429 é™æµé‡è¯•</label>
                            <div class="mb-2 flex items-center gap-2">
                                <input type="checkbox" id="retry429Enabled" style="width: auto;">
                                <label for="retry429Enabled" style="margin: 0;">å¯ç”¨è‡ªåŠ¨é‡è¯•</label>
                            </div>
                            <div class="flex gap-4">
                                <div style="flex:1;"><label>æœ€å¤§é‡è¯•æ¬¡æ•°</label><input type="number"
                                        id="retry429MaxRetries" /></div>
                                <div style="flex:1;"><label>é‡è¯•é—´éš” (ç§’)</label><input type="number" id="retry429Interval"
                                        step="0.1" /></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="tab-content">
                <h3>ä¸ªäººä¸­å¿ƒ</h3>
                <div class="config-group">
                    <h4>API Key</h4>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="userApiKey" readonly style="background: #E5E7EB; color: #6B7280;" />
                        <button class="btn" onclick="copyApiKey()">å¤åˆ¶</button>
                    </div>
                    <button class="btn btn-outline-danger" onclick="regenerateApiKey()">é‡ç½® Key</button>
                </div>
                <div class="config-group">
                    <h4>ä¿®æ”¹å¯†ç </h4>
                    <div class="flex gap-2">
                        <input type="password" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç " />
                        <button class="btn" onclick="changePassword()">ç¡®è®¤ä¿®æ”¹</button>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logsTab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h3>ç³»ç»Ÿæ—¥å¿—</h3>
                    <div class="flex gap-2">
                        <button class="btn" onclick="connectWebSocket()">è¿æ¥</button>
                        <button class="btn btn-outline-danger" onclick="disconnectWebSocket()">æ–­å¼€</button>
                        <button class="btn btn-secondary" onclick="clearLogs()">æ¸…ç©º</button>
                        <button class="btn btn-secondary" onclick="downloadLogs()">ä¸‹è½½</button>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4 text-sm text-secondary">
                    <div id="logConnectionStatus" class="flex items-center gap-2">
                        <span style="width: 8px; height: 8px; border-radius: 50%; background: var(--secondary);"
                            id="statusDot"></span>
                        <span id="connectionStatusText">æœªè¿æ¥</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <select id="logLevelFilter" onchange="filterLogs()" style="width: auto; padding: 0.25rem;">
                            <option value="all">æ‰€æœ‰æ—¥å¿—</option>
                            <option value="ERROR">ERROR</option>
                            <option value="WARNING">WARNING</option>
                            <option value="INFO">INFO</option>
                        </select>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="autoScroll" checked style="width: auto;">
                            <label for="autoScroll" style="margin: 0;">è‡ªåŠ¨æ»šåŠ¨</label>
                        </div>
                    </div>
                </div>
                <pre id="logContainer" style="height: 500px; color: #10B981;">
                    <div id="logContent">ç­‰å¾…è¿æ¥...</div>
                </pre>
            </div>

        </div> <!-- End Content Card -->

        <div id="statusSection"></div>
    </div>

    <!-- Scripts -->
    <script>

        // Global State
        let currentProjectId = '';
        let authInProgress = false;
        let uploadSelectedFiles = [];
        let authToken = '';
        let credsData = {};
        let filteredCredsData = {};
        let currentPage = 1;
        let pageSize = 20;
        let currentFilter = 'all';
        let currentErrorCodeFilter = 'all';
        let selectedCredFiles = new Set();
        let availableErrorCodes = new Set();
        let statsData = { total: 0, normal: 0, disabled: 0 };
        let usageStatsData = {};
        let logWebSocket = null;
        let allLogs = [];
        let filteredLogs = [];
        let currentLogFilter = 'all';
        let isLoginMode = true;
        let envLockedFields = new Set();

        // --- UI Helpers ---
        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusSection');
            if (!container) return alert(message);

            const div = document.createElement('div');
            div.className = `status-msg ${type}`;
            div.textContent = message;

            container.appendChild(div);
            // Auto remove
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transition = 'opacity 0.5s';
                setTimeout(() => div.remove(), 500);
            }, 3000);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
            return Math.round(bytes / (1024 * 1024)) + ' MB';
        }

        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        // --- Auth & Profile ---
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').textContent = isLoginMode ? 'æ¬¢è¿å›æ¥' : 'åˆ›å»ºè´¦å·';
            document.getElementById('authSubtitle').textContent = isLoginMode ? 'è¯·ç™»å½•ä»¥ç»§ç»­ç®¡ç†æ‚¨çš„æœåŠ¡' : 'æ³¨å†Œä¸€ä¸ªæ–°çš„è´¦å·';
            document.getElementById('authBtn').textContent = isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ';
            document.getElementById('authToggleLink').textContent = isLoginMode ? 'æ³¨å†Œæ–°è´¦å·' : 'å·²æœ‰è´¦å·ï¼Ÿç«‹å³ç™»å½•';
        }

        function handlePasswordEnter(event) {
            if (event.key === 'Enter') handleAuth();
        }

        async function handleAuth() {
            const u = document.getElementById('loginUsername').value;
            const p = document.getElementById('loginPassword').value;
            if (!u || !p) return showStatus('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');

            const endpoint = isLoginMode ? '/auth/login' : '/auth/register';
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();

                if (res.ok) {
                    if (isLoginMode) {
                        authToken = data.token;
                        localStorage.setItem('gcli_token', data.token);
                        localStorage.setItem('gcli_username', u);
                        localStorage.setItem('gcli_role', data.role);
                        localStorage.setItem('gcli_api_key', data.api_key);

                        document.getElementById('loginSection').classList.add('hidden');
                        document.getElementById('mainSection').classList.remove('hidden');

                        updateProfileUI(u, data.role, data.api_key);
                        showStatus('ç™»å½•æˆåŠŸ', 'success');
                        loadSystemAnnouncement();
                    } else {
                        showStatus('æ³¨å†ŒæˆåŠŸ', 'success');
                        toggleAuthMode();
                    }
                } else {
                    showStatus(data.detail || data.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (e) {
                showStatus('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
            }
        }

        function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
            localStorage.clear();
            window.location.reload();
        }

        function updateProfileUI(username, role, apiKey) {
            document.getElementById('profileUsername').textContent = username;
            document.getElementById('profileRoleBadge').textContent = role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·';
            document.getElementById('profileRoleBadge').className = `badge ${role === 'admin' ? 'badge-success' : 'badge-secondary'}`;

            const keyInput = document.getElementById('userApiKey');
            if (keyInput) keyInput.value = apiKey || '';

            const isAdmin = role === 'admin';
            const adminLink = document.getElementById('adminPanelLink');
            if (adminLink) adminLink.classList.toggle('hidden', !isAdmin);

            // Hide admin tabs if not admin
            if (role !== 'admin') {
                const adminTabs = ['envload', 'config', 'logs'];
                adminTabs.forEach(t => {
                    const btn = document.querySelector(`.tab[data-tab="${t}"]`);
                    if (btn) btn.style.display = 'none';
                });
            }
        }

        async function loadSystemAnnouncement() {
            try {
                if (!authToken) return;
                const response = await fetch('/announcement', { headers: getAuthHeaders() });
                if (!response.ok) return;
                const data = await response.json();

                const banner = document.getElementById('systemAnnouncement');
                const text = document.getElementById('announcementText');

                if (data && data.enabled && data.content) {
                    text.textContent = data.content;
                    banner.classList.remove('hidden');
                    if (data.level === 'danger') banner.style.borderLeftColor = 'var(--error)';
                } else {
                    banner.classList.add('hidden');
                }
            } catch (e) { console.error(e); }
        }

        function checkLocalLogin() {
            const token = localStorage.getItem('gcli_token');
            if (token) {
                authToken = token;
                updateProfileUI(
                    localStorage.getItem('gcli_username'),
                    localStorage.getItem('gcli_role'),
                    localStorage.getItem('gcli_api_key')
                );
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                loadSystemAnnouncement();
            }
        }

        // --- Tabs ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const btn = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (btn) btn.classList.add('active');

            const content = document.getElementById(`${tabName}Tab`);
            if (content) content.classList.add('active');

            // Lazy load
            if (tabName === 'manage') refreshCredsStatus();
            if (tabName === 'usage') refreshUsageStats();
            if (tabName === 'config') loadConfig();
            if (tabName === 'envload') checkEnvCredsStatus();
            if (tabName === 'logs') connectWebSocket();
        }

        // --- OAuth ---
        function toggleProjectIdSection() {
            const sec = document.getElementById('projectIdSection');
            const icon = document.getElementById('projectIdToggleIcon');
            const isHidden = sec.classList.contains('hidden');
            sec.classList.toggle('hidden');
            icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function handleGetAllProjectsChange() {
            const checked = document.getElementById('getAllProjectsCreds').checked;
            const note = document.getElementById('allProjectsNote');
            if (note) note.classList.toggle('hidden', !checked);
        }

        async function startAuth() {
            const pid = document.getElementById('projectId').value.trim();
            const all = document.getElementById('getAllProjectsCreds').checked;
            currentProjectId = pid || null;

            const btn = document.getElementById('getAuthBtn');
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';

            try {
                const res = await fetch('/auth/start', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ project_id: pid || undefined, get_all_projects: all })
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('authUrl').href = data.auth_url;
                    //document.getElementById('authUrl').textContent = data.auth_url; // Keep constant text
                    document.getElementById('authUrlSection').classList.remove('hidden');
                    authInProgress = true;
                    showStatus('è®¤è¯é“¾æ¥ç”ŸæˆæˆåŠŸ', 'success');
                } else {
                    showStatus(data.error || 'å¤±è´¥', 'error');
                }
            } catch (e) {
                showStatus(e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'è·å–è®¤è¯é“¾æ¥';
            }
        }

        function toggleCallbackUrlSection() {
            const sec = document.getElementById('callbackUrlSection');
            const icon = document.getElementById('callbackUrlToggleIcon');
            const isHidden = sec.classList.contains('hidden');
            sec.classList.toggle('hidden');
            icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        async function processCallbackUrl() {
            const url = document.getElementById('callbackUrlInput').value.trim();
            const all = document.getElementById('getAllProjectsCreds').checked;
            if (!url) return showStatus('è¯·è¾“å…¥URL', 'error');

            try {
                const res = await fetch('/auth/callback-url', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ callback_url: url, project_id: currentProjectId, get_all_projects: all })
                });
                const result = await res.json(); // Use result variable

                if (res.ok) {
                    handleAuthResult(result);
                } else {
                    showStatus(result.error || result.detail || 'å¤±è´¥', 'error');
                }
            } catch (e) { showStatus(e.message, 'error'); }
        }

        async function getCredentials() {
            //if(!authInProgress) return showStatus('è¯·å…ˆè·å–é“¾æ¥å¹¶æˆæƒ', 'error');
            const all = document.getElementById('getAllProjectsCreds').checked;
            const btn = document.getElementById('getCredsBtn');
            btn.disabled = true;
            btn.textContent = 'è·å–ä¸­...';

            try {
                const res = await fetch('/auth/callback', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ project_id: currentProjectId, get_all_projects: all })
                });
                const data = await res.json();

                if (res.ok) {
                    handleAuthResult(data);
                    authInProgress = false;
                } else {
                    showStatus(data.error || 'è·å–å¤±è´¥', 'error');
                }
            } catch (e) { showStatus(e.message, 'error'); }
            finally { btn.disabled = false; btn.textContent = 'è·å–å‡­è¯æ–‡ä»¶'; }
        }

        function handleAuthResult(data) {
            const area = document.getElementById('credentialsContent');
            const content = data.multiple_credentials || data.credentials;
            area.textContent = JSON.stringify(content, null, 2);
            document.getElementById('credentialsSection').classList.remove('hidden');

            if (data.multiple_credentials) {
                const s = data.multiple_credentials.success.length;
                const f = data.multiple_credentials.failed.length;
                showStatus(`æ‰¹é‡è®¤è¯ç»“æŸ: æˆåŠŸ ${s}, å¤±è´¥ ${f}`, 'success');
            } else {
                showStatus('è®¤è¯æˆåŠŸ', 'success');
            }
        }

        // --- Upload ---
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }
        function addFiles(files) {
            files.forEach(f => {
                if ((f.name.endsWith('.json') || f.name.endsWith('.zip')) && !uploadSelectedFiles.find(x => x.name === f.name)) {
                    uploadSelectedFiles.push(f);
                }
            });
            updateFileList();
        }
        function updateFileList() {
            const list = document.getElementById('fileList');
            const section = document.getElementById('fileListSection');

            if (uploadSelectedFiles.length === 0) return section.classList.add('hidden');
            section.classList.remove('hidden');
            list.innerHTML = '';

            uploadSelectedFiles.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <span>${f.name} <small class="text-secondary">(${formatFileSize(f.size)})</small></span>
                    <button class="btn btn-outline-danger" style="padding: 0.1rem 0.5rem;" onclick="removeFile(${i})">ç§»é™¤</button>
                 `;
                list.appendChild(div);
            });
        }
        function removeFile(i) { uploadSelectedFiles.splice(i, 1); updateFileList(); }
        function clearFiles() { uploadSelectedFiles = []; updateFileList(); }

        async function uploadFiles() {
            if (uploadSelectedFiles.length === 0) return;
            const formData = new FormData();
            uploadSelectedFiles.forEach(f => formData.append('files', f));

            const pSec = document.getElementById('uploadProgressSection');
            const pFill = document.getElementById('progressFill');
            const pText = document.getElementById('progressText');
            pSec.classList.remove('hidden');

            try {
                const xhr = new XMLHttpRequest();
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const pct = (e.loaded / e.total) * 100;
                        pFill.style.width = pct + '%';
                        pText.textContent = Math.round(pct) + '%';
                    }
                };
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        showStatus('ä¸Šä¼ æˆåŠŸ', 'success');
                        clearFiles();
                        pSec.classList.add('hidden');
                    } else showStatus('ä¸Šä¼ å¤±è´¥', 'error');
                };
                xhr.onerror = () => showStatus('ç½‘ç»œé”™è¯¯', 'error');
                xhr.open('POST', '/auth/upload');
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.send(formData);
            } catch (e) { showStatus(e.message, 'error'); }
        }

        // --- Env Load ---
        async function checkEnvCredsStatus() {
            const load = document.getElementById('envStatusLoading');
            const cont = document.getElementById('envStatusContent');
            load.style.display = 'block'; cont.classList.add('hidden');

            try {
                const res = await fetch('/auth/env-creds-status', { headers: getAuthHeaders() });
                const data = await res.json();
                if (res.ok) {
                    document.getElementById('envVarsList').textContent = Object.keys(data.available_env_vars).join(', ') || 'None';
                    document.getElementById('autoLoadStatus').textContent = data.auto_load_enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
                    document.getElementById('autoLoadStatus').className = `badge ${data.auto_load_enabled ? 'badge-success' : 'badge-warning'}`;
                    document.getElementById('envFilesCount').textContent = data.existing_env_files_count;
                    document.getElementById('envFilesList').textContent = data.existing_env_files.join(', ') || 'æ— ';
                    cont.classList.remove('hidden');
                }
            } catch (e) { showStatus(e.message, 'error'); }
            finally { load.style.display = 'none'; }
        }

        async function loadEnvCredentials() {
            try {
                const res = await fetch('/auth/load-env-creds', { method: 'POST', headers: getAuthHeaders() });
                const data = await res.json();
                if (res.ok) {
                    showStatus(`å¯¼å…¥æˆåŠŸ: ${data.loaded_count}/${data.total_count}`, 'success');
                    checkEnvCredsStatus();
                } else showStatus(data.error, 'error');
            } catch (e) { showStatus(e.message, 'error'); }
        }

        async function clearEnvCredentials() {
            if (!confirm('ç¡®å®šæ¸…é™¤å—ï¼Ÿ')) return;
            try {
                const res = await fetch('/auth/env-creds', { method: 'DELETE', headers: getAuthHeaders() });
                const data = await res.json();
                if (res.ok) {
                    showStatus('æ¸…é™¤æˆåŠŸ', 'success');
                    checkEnvCredsStatus();
                } else showStatus(data.error, 'error');
            } catch (e) { showStatus(e.message, 'error'); }
        }

        // --- Manage Creds ---
        async function refreshCredsStatus() {
            const load = document.getElementById('credsLoading');
            const list = document.getElementById('credsList');
            load.style.display = 'block'; list.innerHTML = '';

            try {
                const res = await fetch('/creds/status', { headers: getAuthHeaders() });
                const data = await res.json();
                if (res.ok) {
                    credsData = data.creds;
                    calculateStats();
                    applyFilters(); // Renders list
                }
            } catch (e) { showStatus(e.message, 'error'); }
            finally { load.style.display = 'none'; }
        }

        function calculateStats() {
            statsData = { total: 0, normal: 0, disabled: 0 };
            availableErrorCodes.clear();
            for (const [k, v] of Object.entries(credsData)) {
                statsData.total++;
                if (v.status.disabled) statsData.disabled++; else statsData.normal++;
                if (v.status.error_codes) v.status.error_codes.forEach(c => availableErrorCodes.add(c));
            }
            // Update UI Stats
            document.getElementById('statTotal').textContent = statsData.total;
            document.getElementById('statNormal').textContent = statsData.normal;
            document.getElementById('statDisabled').textContent = statsData.disabled;
        }

        function applyFilters() {
            const sFilter = document.getElementById('statusFilter').value;
            const eFilter = document.getElementById('errorCodeFilter').value;
            filteredCredsData = {};

            for (const [path, info] of Object.entries(credsData)) {
                if (sFilter === 'normal' && info.status.disabled) continue;
                if (sFilter === 'disabled' && !info.status.disabled) continue;

                const codes = info.status.error_codes || [];
                if (eFilter === 'no-errors' && codes.length > 0) continue;
                if (eFilter === 'has-errors' && codes.length === 0) continue;
                // Note: basic error filtering implemented, exact code match left out for brevity but straightforward to add

                filteredCredsData[path] = info;
            }

            currentPage = 1;
            renderCredsList();
        }

        function renderCredsList() {
            const list = document.getElementById('credsList');
            list.innerHTML = '';
            const entries = Object.entries(filteredCredsData);
            const start = (currentPage - 1) * pageSize;
            const pageItems = entries.slice(start, start + pageSize);

            if (pageItems.length === 0) {
                list.innerHTML = '<div class="text-center text-secondary p-4">æš‚æ— æ•°æ®</div>';
            } else {
                pageItems.forEach(([path, info]) => {
                    list.appendChild(createCredCard(path, info));
                });
            }

            // Pagination UI
            const totalPages = Math.ceil(entries.length / pageSize);
            const pCont = document.getElementById('paginationContainer');
            if (totalPages > 1) {
                pCont.classList.remove('hidden');
                pCont.style.display = 'flex'; // override hidden
                document.getElementById('paginationInfo').textContent = `${currentPage} / ${totalPages}`;
                document.getElementById('prevPageBtn').disabled = currentPage <= 1;
                document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
            } else {
                pCont.classList.add('hidden');
            }

            updateBatchControls();
        }

        function changePage(d) { currentPage += d; renderCredsList(); }
        function changePageSize() { pageSize = parseInt(document.getElementById('pageSizeSelect').value); currentPage = 1; renderCredsList(); }

        function createCredCard(fullPath, info) {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.style.flexDirection = 'column';
            div.style.alignItems = 'stretch';

            const pathId = btoa(encodeURIComponent(fullPath)).replace(/[+/=]/g, '_');
            const statusBadge = info.status.disabled
                ? '<span class="badge badge-secondary">å·²ç¦ç”¨</span>'
                : '<span class="badge badge-success">æ­£å¸¸</span>';

            const errorBadges = (info.status.error_codes || []).map(c =>
                `<span class="badge badge-error ml-2">Error ${c}</span>`
            ).join('');

            div.innerHTML = `
                <div class="flex items-center justify-between w-full mb-2">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" class="file-checkbox" data-filename="${info.filename}" onchange="toggleFileSelection('${info.filename}')">
                        <div>
                            <div class="font-bold flex items-center">
                                ${info.filename}
                                ${statusBadge}
                                ${errorBadges}
                            </div>
                            <div class="text-sm text-secondary">${info.user_email || 'æœªè·å–é‚®ç®±'}</div>
                        </div>
                    </div>
                </div>
                <div class="cred-actions w-full justify-end">
                    ${info.status.disabled
                    ? `<button class="btn btn-secondary" onclick="credAction('${info.filename}', 'enable')">å¯ç”¨</button>`
                    : `<button class="btn btn-secondary" onclick="credAction('${info.filename}', 'disable')">ç¦ç”¨</button>`}
                    
                    <button class="btn btn-secondary" onclick="toggleCredDetails('${pathId}')">è¯¦æƒ…</button>
                    <button class="btn btn-secondary" onclick="downloadCred('${info.filename}')">ä¸‹è½½</button>
                    <button class="btn btn-secondary" onclick="fetchUserEmail('${info.filename}')">é‚®ç®±</button>
                    <button class="btn btn-outline-danger" onclick="deleteCred('${info.filename}')">åˆ é™¤</button>
                </div>
                <div id="det-${pathId}" class="hidden w-full mt-2">
                    <pre>${JSON.stringify(info.content || {}, null, 2)}</pre>
                </div>
            `;
            // Checkbox state
            const cb = div.querySelector('.file-checkbox');
            if (cb) cb.checked = selectedCredFiles.has(info.filename);

            return div;
        }

        function toggleCredDetails(id) {
            document.getElementById('det-' + id).classList.toggle('hidden');
        }

        // Batch Actions
        function toggleFileSelection(f) {
            if (selectedCredFiles.has(f)) selectedCredFiles.delete(f); else selectedCredFiles.add(f);
            updateBatchControls();
        }
        function toggleSelectAll() {
            const all = document.getElementById('selectAllCheckbox').checked;
            document.querySelectorAll('.file-checkbox').forEach(cb => {
                cb.checked = all;
                const f = cb.getAttribute('data-filename');
                if (all) selectedCredFiles.add(f); else selectedCredFiles.delete(f);
            });
            updateBatchControls();
        }
        function updateBatchControls() {
            document.getElementById('selectedCount').textContent = `å·²é€‰ ${selectedCredFiles.size} é¡¹`;
            const has = selectedCredFiles.size > 0;
            document.getElementById('batchEnableBtn').disabled = !has;
            document.getElementById('batchDisableBtn').disabled = !has;
            document.getElementById('batchDeleteBtn').disabled = !has;
        }

        async function batchAction(action) {
            if (!confirm(`ç¡®å®šå¯¹ ${selectedCredFiles.size} ä¸ªæ–‡ä»¶æ‰§è¡Œ ${action} å—ï¼Ÿ`)) return;
            try {
                const res = await fetch('/creds/batch-action', {
                    method: 'POST', headers: getAuthHeaders(),
                    body: JSON.stringify({ action, filenames: Array.from(selectedCredFiles) })
                });
                if (res.ok) {
                    showStatus('æ‰¹é‡æ“ä½œæˆåŠŸ', 'success');
                    selectedCredFiles.clear();
                    refreshCredsStatus();
                } else showStatus('æ“ä½œå¤±è´¥', 'error');
            } catch (e) { showStatus(e.message, 'error'); }
        }

        // Single Actions
        async function credAction(f, a) {
            try {
                await fetch('/creds/action', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ filename: f, action: a }) });
                refreshCredsStatus();
            } catch (e) { showStatus(e.message, 'error'); }
        }
        async function deleteCred(f) {
            if (!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿä¸å¯æ¢å¤')) return;
            credAction(f, 'delete');
        }
        async function downloadAllCreds() {
            try {
                const res = await fetch('/creds/download-all', { headers: getAuthHeaders() });
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'credentials.zip';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } else {
                    const data = await res.json();
                    showStatus(data.error || 'ä¸‹è½½å¤±è´¥', 'error');
                }
            } catch (e) { showStatus(e.message, 'error'); }
        }

        async function downloadCred(filename) {
            try {
                const res = await fetch(`/creds/download/${filename}`, { headers: getAuthHeaders() });
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } else {
                    const data = await res.json();
                    showStatus(data.error || 'ä¸‹è½½å¤±è´¥', 'error');
                }
            } catch (e) { showStatus(e.message, 'error'); }
        }
        async function fetchUserEmail(f) {
            try {
                const res = await fetch(`/creds/fetch-email/${encodeURIComponent(f)}`, { method: 'POST', headers: getAuthHeaders() });
                if (res.ok) refreshCredsStatus(); else showStatus('è·å–å¤±è´¥', 'error');
            } catch (e) { showStatus(e.message, 'error'); }
        }
        async function refreshAllEmails() {
            if (!confirm('ç¡®å®šåˆ·æ–°æ‰€æœ‰é‚®ç®±å—ï¼Ÿå¯èƒ½è¾ƒæ…¢')) return;
            try {
                const res = await fetch('/creds/refresh-all-emails', { method: 'POST', headers: getAuthHeaders() });
                if (res.ok) refreshCredsStatus(); else showStatus('åˆ·æ–°å¤±è´¥', 'error');
            } catch (e) { showStatus(e.message, 'error'); }
        }

        // --- Usage ---
        async function refreshUsageStats() {
            const load = document.getElementById('usageLoading');
            const list = document.getElementById('usageList');
            load.style.display = 'block'; list.innerHTML = '';

            try {
                const res = await fetch('/usage/aggregated', { headers: getAuthHeaders() });
                const data = await res.json();
                if (res.ok) {
                    const d = data.data;
                    document.getElementById('totalApiCalls').textContent = d.total_calls_24h;
                    document.getElementById('activeFilesCount').textContent = d.total_files;
                    document.getElementById('avgCallsPerFile').textContent = Math.round(d.avg_calls_per_file);

                    if (d.files_breakdown) {
                        d.files_breakdown.forEach(item => {
                            const card = document.createElement('div');
                            card.className = 'stat-card';
                            card.innerHTML = `
                                <div class="font-bold mb-2 break-all">${item.filename}</div>
                                <div class="stat-val text-info text-xl">${item.calls_24h}</div>
                                <div class="stat-label">Calls</div>
                             `;
                            list.appendChild(card);
                        });
                    }
                }
            } catch (e) { showStatus(e.message, 'error'); }
            finally { load.style.display = 'none'; }
        }

        // --- Config ---
        async function loadConfig() {
            const load = document.getElementById('configLoading');
            const form = document.getElementById('configForm');
            load.style.display = 'block'; form.classList.add('hidden');

            try {
                const res = await fetch('/config/get', { headers: getAuthHeaders() });
                const data = await res.json();
                if (res.ok) {
                    const c = data.config || data;
                    // Map fields
                    setVal('host', c.host);
                    setVal('port', c.port);
                    setVal('credentialsDir', c.credentials_dir);
                    setVal('proxy', c.proxy);
                    setVal('codeAssistEndpoint', c.code_assist_endpoint);
                    setVal('oauthProxyUrl', c.oauth_proxy_url);
                    setVal('googleapisProxyUrl', c.googleapis_proxy_url);
                    setVal('resourceManagerApiUrl', c.resource_manager_api_url);
                    setVal('serviceUsageApiUrl', c.service_usage_api_url);

                    setCheck('autoBanEnabled', c.auto_ban_enabled);
                    setVal('autoBanErrorCodes', (c.auto_ban_error_codes || []).join(','));
                    setVal('callsPerRotation', c.calls_per_rotation);
                    setVal('antiTruncationMaxAttempts', c.anti_truncation_max_attempts);

                    setCheck('compatibilityModeEnabled', c.compatibility_mode_enabled);
                    setCheck('returnThoughtsToFrontend', c.return_thoughts_to_frontend);

                    if (c.retry_429_enabled !== undefined) setCheck('retry429Enabled', c.retry_429_enabled);
                    if (c.retry_429_max_retries !== undefined) setVal('retry429MaxRetries', c.retry_429_max_retries);
                    if (c.retry_429_interval !== undefined) setVal('retry429Interval', c.retry_429_interval);

                    form.classList.remove('hidden');
                }
            } catch (e) { showStatus(e.message, 'error'); }
            finally { load.style.display = 'none'; }
        }
        function setVal(id, v) { const el = document.getElementById(id); if (el) el.value = v === undefined ? '' : v; }
        function setCheck(id, v) { const el = document.getElementById(id); if (el) el.checked = !!v; }

        async function saveConfig() {
            const c = {
                host: document.getElementById('host').value,
                port: parseInt(document.getElementById('port').value),
                credentials_dir: document.getElementById('credentialsDir').value,
                proxy: document.getElementById('proxy').value,
                code_assist_endpoint: document.getElementById('codeAssistEndpoint').value,
                oauth_proxy_url: document.getElementById('oauthProxyUrl').value,
                googleapis_proxy_url: document.getElementById('googleapisProxyUrl').value,
                resource_manager_api_url: document.getElementById('resourceManagerApiUrl').value,
                service_usage_api_url: document.getElementById('serviceUsageApiUrl').value,
                auto_ban_enabled: document.getElementById('autoBanEnabled').checked,
                auto_ban_error_codes: document.getElementById('autoBanErrorCodes').value.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x)),
                calls_per_rotation: parseInt(document.getElementById('callsPerRotation').value),
                anti_truncation_max_attempts: parseInt(document.getElementById('antiTruncationMaxAttempts').value),
                compatibility_mode_enabled: document.getElementById('compatibilityModeEnabled').checked,
                return_thoughts_to_frontend: document.getElementById('returnThoughtsToFrontend').checked,
                retry_429_enabled: document.getElementById('retry429Enabled').checked,
                retry_429_max_retries: parseInt(document.getElementById('retry429MaxRetries').value),
                retry_429_interval: parseFloat(document.getElementById('retry429Interval').value)
            };

            try {
                const res = await fetch('/config/save', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ config: c }) });
                const data = await res.json();
                if (res.ok) showStatus('é…ç½®ä¿å­˜æˆåŠŸ' + (data.restart_required ? ' (éœ€é‡å¯)' : ''), 'success');
                else showStatus('ä¿å­˜å¤±è´¥', 'error');
            } catch (e) { showStatus(e.message, 'error'); }
        }

        const mirrors = {
            codeAssistEndpoint: 'https://gcli-api.sukaka.top/cloudcode-pa',
            oauthProxyUrl: 'https://gcli-api.sukaka.top/oauth2',
            googleapisProxyUrl: 'https://gcli-api.sukaka.top/googleapis',
            resourceManagerApiUrl: 'https://gcli-api.sukaka.top/cloudresourcemanager',
            serviceUsageApiUrl: 'https://gcli-api.sukaka.top/serviceusage'
        };
        const officials = {
            codeAssistEndpoint: 'https://cloudcode-pa.googleapis.com',
            oauthProxyUrl: 'https://oauth2.googleapis.com',
            googleapisProxyUrl: 'https://www.googleapis.com',
            resourceManagerApiUrl: 'https://cloudresourcemanager.googleapis.com',
            serviceUsageApiUrl: 'https://serviceusage.googleapis.com'
        };
        function useMirrorUrls() {
            for (const [k, v] of Object.entries(mirrors)) setVal(k, v);
            showStatus('å·²å¡«å……é•œåƒåœ°å€');
        }
        function restoreOfficialUrls() {
            for (const [k, v] of Object.entries(officials)) setVal(k, v);
            showStatus('å·²æ¢å¤å®˜æ–¹åœ°å€');
        }

        // --- Profile ---
        function copyApiKey() {
            const el = document.getElementById('userApiKey');
            el.select(); document.execCommand('copy');
            showStatus('å·²å¤åˆ¶');
        }
        async function regenerateApiKey() {
            if (!confirm('ç¡®å®šé‡ç½®å—ï¼Ÿæ—§Keyå¤±æ•ˆ')) return;
            try {
                const res = await fetch('/user/api-key', { method: 'POST', headers: getAuthHeaders() });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('gcli_api_key', data.api_key);
                    document.getElementById('userApiKey').value = data.api_key;
                    showStatus('é‡ç½®æˆåŠŸ', 'success');
                } else showStatus('å¤±è´¥', 'error');
            } catch (e) { showStatus(e.message, 'error'); }
        }
        async function changePassword() {
            const p = document.getElementById('newPassword').value;
            try {
                const res = await fetch('/user/password', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ new_password: p }) });
                if (res.ok) { document.getElementById('newPassword').value = ''; showStatus('ä¿®æ”¹æˆåŠŸ', 'success'); }
                else showStatus('å¤±è´¥', 'error');
            } catch (e) { showStatus(e.message, 'error'); }
        }

        // --- Logs ---
        function connectWebSocket() {
            if (logWebSocket) return;
            const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            logWebSocket = new WebSocket(`${proto}//${window.location.host}/auth/logs/stream?token=${authToken}`);
            logWebSocket.onopen = () => {
                document.getElementById('connectionStatusText').textContent = 'å·²è¿æ¥';
                document.getElementById('statusDot').style.background = 'var(--success)';
            };
            logWebSocket.onmessage = (e) => {
                allLogs.push(e.data);
                if (allLogs.length > 1000) allLogs.shift();
                filterLogs();
                if (document.getElementById('autoScroll').checked) {
                    const c = document.getElementById('logContainer');
                    c.scrollTop = c.scrollHeight;
                }
            };
            logWebSocket.onclose = () => {
                document.getElementById('connectionStatusText').textContent = 'å·²æ–­å¼€';
                document.getElementById('statusDot').style.background = 'var(--error)';
                logWebSocket = null;
            };
        }
        function disconnectWebSocket() { if (logWebSocket) logWebSocket.close(); }
        function filterLogs() {
            const f = document.getElementById('logLevelFilter').value;
            const c = document.getElementById('logContainer');
            if (f === 'all') c.textContent = allLogs.join('\n');
            else c.textContent = allLogs.filter(l => l.includes(f)).join('\n');
        }
        async function clearLogs() {
            try { await fetch('/auth/logs/clear', { method: 'POST', headers: getAuthHeaders() }); allLogs = []; filterLogs(); } catch (e) { }
        }
        async function downloadLogs() { window.open('/auth/logs/download?token=' + authToken, '_blank'); }

        // --- Init ---
        window.onload = checkLocalLogin;

    </script>
</body>

</html>