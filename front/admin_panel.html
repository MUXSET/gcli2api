<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCLI2API ç®¡ç†åå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .badge-role {
            font-size: 0.9em;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        body.dark-mode .navbar {
            background-color: #1e1e1e !important;
            border-bottom: 1px solid #333;
        }

        body.dark-mode .navbar-brand,
        body.dark-mode .navbar-text {
            color: #e0e0e0 !important;
        }

        body.dark-mode .card {
            background-color: #1e1e1e;
            border-color: #333;
            color: #e0e0e0;
        }

        body.dark-mode .card-header {
            background-color: #252525;
            border-bottom-color: #333;
        }

        body.dark-mode .table {
            color: #e0e0e0;
            --bs-table-color: #e0e0e0;
            --bs-table-hover-color: #e0e0e0;
            --bs-table-bg: #1e1e1e;
            --bs-table-hover-bg: #2c2c2c;
            border-color: #333;
        }

        body.dark-mode .table-striped>tbody>tr:nth-of-type(odd)>* {
            --bs-table-accent-bg: #252525;
            color: #e0e0e0;
        }

        body.dark-mode .modal-content {
            background-color: #1e1e1e;
            border-color: #333;
            color: #e0e0e0;
        }

        body.dark-mode .modal-header,
        body.dark-mode .modal-footer {
            border-color: #333;
        }

        body.dark-mode .close {
            filter: invert(1);
        }

        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background-color: #2c2c2c;
            border-color: #444;
            color: #e0e0e0;
        }

        body.dark-mode .form-text {
            color: #aaa;
        }

        body.dark-mode .login-container {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-content.dark-mode {
            background-color: #1e1e1e;
            border-color: #333;
            color: #e0e0e0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .modal-body {
            padding-bottom: 20px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-light bg-white rounded shadow-sm mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">GCLI2API Admin</a>
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary btn-sm me-3" onclick="toggleDarkMode()"
                        id="themeToggleBtn">ğŸŒ™</button>
                    <span class="navbar-text me-3" id="currentUserDisplay">Loading...</span>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>

        <!-- Dashboard -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card h-100">
                    <div class="card-header">æµé‡è¶‹åŠ¿ (24h)</div>
                    <div class="card-body" style="height: 300px">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card h-100">
                    <div class="card-header">å“åº”å»¶è¿Ÿè¶‹åŠ¿ (å¹³å‡ / P95)</div>
                    <div class="card-body" style="height: 300px">
                        <canvas id="latencyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">å‡­è¯çŠ¶æ€åˆ†å¸ƒ</div>
                    <div class="card-body" style="height: 300px">
                        <canvas id="healthChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">å‡­è¯å½’å±åˆ†å¸ƒ</div>
                    <div class="card-body" style="height: 300px">
                        <canvas id="ownershipChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Errors -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">æœ€è¿‘ç³»ç»ŸæŠ¥é”™ (Last 50)</h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="fetchErrorLogs()">åˆ·æ–°æ—¥å¿—</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped mb-0 small">
                                <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                                    <tr>
                                        <th>æ—¶é—´</th>
                                        <th>å‡­è¯</th>
                                        <th>User ID</th>
                                        <th>çŠ¶æ€ç </th>
                                        <th>é”™è¯¯è¯¦æƒ…</th>
                                    </tr>
                                </thead>
                                <tbody id="errorLogTableBody">
                                    <!-- Logs -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ç”¨æˆ·ç®¡ç†</h5>
                        <button class="btn btn-primary btn-sm" onclick="loadUsers()">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ç”¨æˆ·å</th>
                                        <th>è§’è‰²</th>
                                        <th>é…é¢ (Quota)</th>
                                        <th>çŠ¶æ€ (Status)</th>
                                        <th>æ³¨å†Œæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody">
                                    <!-- ç”¨æˆ·åˆ—è¡¨å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ç³»ç»Ÿå®¡è®¡æ—¥å¿— (Audit Logs)</h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="fetchAuditLogs()">åˆ·æ–°æ—¥å¿—</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="p-2 border-bottom d-flex gap-2 align-items-center flex-wrap bg-light">
                            <select id="auditActionFilter" class="form-select form-select-sm" style="width: 110px;">
                                <option value="">æ‰€æœ‰æ“ä½œ</option>
                                <option value="login_success">ç™»å½•æˆåŠŸ</option>
                                <option value="login_failed">ç™»å½•å¤±è´¥</option>
                                <option value="upload_credential">ä¸Šä¼ å‡­è¯</option>
                                <option value="upload_credential_failed">ä¸Šä¼ å¤±è´¥</option>
                                <option value="delete_credential">åˆ é™¤å‡­è¯</option>
                                <option value="toggle_credential">åˆ‡æ¢å‡­è¯</option>
                                <option value="download_credential">ä¸‹è½½å‡­è¯</option>
                                <option value="update_user_status">ç”¨æˆ·æ›´æ–°</option>
                                <option value="impersonate_user">æ¨¡æ‹Ÿç”¨æˆ·</option>
                            </select>
                            <input type="text" id="auditUserFilter" class="form-control form-control-sm"
                                placeholder="ç”¨æˆ· ID" style="width: 120px;">
                            <input type="date" id="auditStartDate" class="form-control form-control-sm"
                                style="width: 130px;">
                            <span class="text-muted">-</span>
                            <input type="date" id="auditEndDate" class="form-control form-control-sm"
                                style="width: 130px;">

                            <button class="btn btn-primary btn-sm" onclick="fetchAuditLogs(1)">æœç´¢</button>
                            <div class="vr"></div>
                            <button class="btn btn-outline-success btn-sm" onclick="exportAuditLogs()">
                                <i class="bi bi-file-earmark-spreadsheet"></i> å¯¼å‡ºCSV
                            </button>
                        </div>
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-sm table-striped table-hover mb-0 small"
                                style="table-layout: fixed;">
                                <thead
                                    style="position: sticky; top: 0; background: white; z-index: 1; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                    <tr>
                                        <th style="width: 15%;">æ—¶é—´</th>
                                        <th style="width: 10%;">æ“ä½œ</th>
                                        <th style="width: 20%;">ç”¨æˆ· ID</th>
                                        <th style="width: 10%;">IP</th>
                                        <th style="width: 45%;">è¯¦æƒ…</th>
                                    </tr>
                                </thead>
                                <tbody id="auditLogTableBody">
                                    <!-- Logs -->
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer p-2 d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="auditLogInfo">åŠ è½½ä¸­...</small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="changeAuditPage(-1)"
                                    id="auditPrevBtn" disabled>&laquo;</button>
                                <button class="btn btn-outline-secondary" disabled id="auditPageBtn">1</button>
                                <button class="btn btn-outline-secondary" onclick="changeAuditPage(1)" id="auditNextBtn"
                                    disabled>&raquo;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ç³»ç»Ÿè®¾ç½®</h5>
                    </div>
                    <div class="card-body">
                        <form id="configForm">
                            <div class="mb-3 form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isolationMode">
                                <label class="form-check-label" for="isolationMode">
                                    <strong>å‡­è¯éš”ç¦»æ¨¡å¼</strong>
                                    <div class="text-muted small">å¼€å¯åï¼Œç”¨æˆ·åªèƒ½ä½¿ç”¨è‡ªå·±ä¸Šä¼ çš„å‡­è¯ï¼Œä¸”å¿…é¡»ä½¿ç”¨ä¸ªäºº API Key è°ƒç”¨æ¥å£ã€‚</div>
                                </label>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="saveConfig()">ä¿å­˜è®¾ç½®</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ç³»ç»Ÿå…¬å‘Šç®¡ç†</h5>
                    </div>
                    <div class="card-body">
                        <form id="announcementForm">
                            <div class="mb-3">
                                <label for="announcementContent" class="form-label">å…¬å‘Šå†…å®¹</label>
                                <textarea class="form-control" id="announcementContent" rows="3"
                                    placeholder="è¾“å…¥å…¬å‘Šå†…å®¹..."></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="announcementLevel" class="form-label">å…¬å‘Šçº§åˆ«</label>
                                    <select class="form-select" id="announcementLevel">
                                        <option value="info">ä¿¡æ¯ (è“è‰²)</option>
                                        <option value="warning">è­¦å‘Š (é»„è‰²)</option>
                                        <option value="danger">ç´§æ€¥ (çº¢è‰²)</option>
                                        <option value="success">æˆåŠŸ (ç»¿è‰²)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3 d-flex align-items-end">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="announcementEnabled"
                                            checked>
                                        <label class="form-check-label" for="announcementEnabled">å¯ç”¨å…¬å‘Š</label>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="publishAnnouncement()">å‘å¸ƒå…¬å‘Š</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿä¸€å‡­è¯ç®¡ç† (Unified Credential Master View) -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <h5 class="mb-0">å‡­è¯ç®¡ç†ä¸­å¿ƒ</h5>
                            <span id="credentialCountBadge" class="badge bg-secondary">0</span>
                        </div>
                        <div>
                            <button class="btn btn-success btn-sm me-2" onclick="openUploadModal()">ğŸ“¤ å¯¼å…¥å‡­è¯</button>
                            <button class="btn btn-primary btn-sm" onclick="loadAllCredentials()">åˆ·æ–°åˆ—è¡¨</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- æœç´¢å’Œè¿‡æ»¤å·¥å…·æ  -->
                        <div class="row mb-3 g-2">
                            <div class="col-md-4">
                                <input type="text" id="credSearchInput" class="form-control"
                                    placeholder="æœç´¢æ–‡ä»¶åã€å½’å±æˆ–ID..." onkeyup="filterCredentials()">
                            </div>
                            <div class="col-md-2">
                                <select id="credOwnerFilter" class="form-select" onchange="filterCredentials()">
                                    <option value="all">æ‰€æœ‰å½’å±</option>
                                    <option value="Global">ä»… Global</option>
                                    <option value="User">ä»… User</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select id="credStatusFilter" class="form-select" onchange="filterCredentials()">
                                    <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                                    <option value="healthy">å¥åº· (Healthy)</option>
                                    <option value="error">æŠ¥é”™ (Error)</option>
                                    <option value="disabled">ç¦ç”¨ (Disabled)</option>
                                </select>
                            </div>
                            <!-- é¢„ç•™å¯¼å‡º/å¯¼å…¥æŒ‰é’® -->
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary btn-sm me-1" onclick="openImportModal()">ğŸ“¥
                                    å¯¼å…¥å¤‡ä»½</button>
                                <button class="btn btn-outline-success btn-sm" onclick="exportSelectedCredentials()"
                                    id="btnExportSelected" disabled>ğŸ“¦ å¯¼å‡ºé€‰ä¸­</button>
                            </div>
                        </div>

                        <!-- æ‰¹é‡æ“ä½œæ  -->
                        <div class="mb-3 p-2 bg-light rounded d-flex align-items-center gap-3" id="batchActionBar">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllCreds"
                                    onchange="toggleSelectAllCreds()">
                                <label class="form-check-label" for="selectAllCreds">å…¨é€‰</label>
                            </div>
                            <span class="badge bg-secondary" id="selectedCredCount">å·²é€‰ 0 é¡¹</span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-success" onclick="batchCredAction('enable')" id="btnBatchEnable"
                                    disabled>âœ… æ‰¹é‡å¯ç”¨</button>
                                <button class="btn btn-warning" onclick="batchCredAction('disable')"
                                    id="btnBatchDisable" disabled>ğŸš« æ‰¹é‡ç¦ç”¨</button>
                                <button class="btn btn-danger" onclick="batchCredAction('delete')" id="btnBatchDelete"
                                    disabled>ğŸ—‘ æ‰¹é‡åˆ é™¤</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th style="width: 30px;"><input type="checkbox" id="selectAllCredsHeader"
                                                onchange="toggleSelectAllCreds()"></th>
                                        <th>æ–‡ä»¶å</th>
                                        <th>å½’å±</th>
                                        <th>çŠ¶æ€</th>
                                        <th>è°ƒç”¨é‡(24h)</th>
                                        <th>å¥åº·æŒ‡æ ‡</th>
                                        <th>æœ€åæˆåŠŸ</th>
                                        <th>æ“ä½œ</th>
                                        <th>è°ƒè¯•</th>
                                    </tr>
                                </thead>
                                <tbody id="allCredsTableBody">
                                    <!-- å‡­è¯åˆ—è¡¨ -->
                                </tbody>
                            </table>
                        </div>
                        <div class="text-muted small mt-2">
                            æ˜¾ç¤º <span id="visibleCredCount">0</span> / <span id="totalCredCount">0</span> ä¸ªå‡­è¯
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- æ¨¡æ€æ¡†ï¼šé‡ç½®å¯†ç  -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>é‡ç½®ç”¨æˆ·å¯†ç </h3>
                <span class="close" onclick="closeModal('resetPasswordModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>æ­£åœ¨é‡ç½®ç”¨æˆ· <span id="resetPwdUsername" style="font-weight: bold;"></span> çš„å¯†ç </p>
                <div class="form-group">
                    <label>æ–°å¯†ç :</label>
                    <input type="password" id="adminNewPassword" class="form-control" placeholder="è¾“å…¥æ–°å¯†ç ">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="confirmResetPassword()">ç¡®è®¤é‡ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼šæŸ¥çœ‹å‡­è¯ -->
    <div id="viewCredsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>ç”¨æˆ·å‡­è¯åˆ—è¡¨</h3>
                <span class="close" onclick="closeModal('viewCredsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>ç”¨æˆ·: <span id="viewCredsUsername" style="font-weight: bold;"></span></p>
                <div id="credsList" style="max-height: 400px; overflow-y: auto;">
                    <!-- å‡­è¯åˆ—è¡¨å†…å®¹ -->
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="closeModal('viewCredsModal')">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼šæŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡ -->
    <div id="viewUsageModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>ç”¨æˆ·ä½¿ç”¨ç»Ÿè®¡</h3>
                <span class="close" onclick="closeModal('viewUsageModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>ç”¨æˆ·: <span id="viewUsageUsername" style="font-weight: bold;"></span></p>
                <div id="usageList" style="max-height: 400px; overflow-y: auto;">
                    <!-- ç»Ÿè®¡å†…å®¹ -->
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="closeModal('viewUsageModal')">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼šå¯¼å…¥å‡­è¯å¤‡ä»½ -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“¥ å¯¼å…¥å‡­è¯å¤‡ä»½</h3>
                <span class="close" onclick="closeModal('importModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <label>é€‰æ‹©å¤‡ä»½æ–‡ä»¶ (.gcli):</label>
                    <input type="file" id="importFile" class="form-control" accept=".gcli">
                </div>
                <div class="form-group mb-3">
                    <label>è§£å¯†å¯†ç :</label>
                    <input type="password" id="importPassword" class="form-control" placeholder="è¾“å…¥å¤‡ä»½æ—¶è®¾ç½®çš„å¯†ç ">
                </div>
                <div class="form-group mb-3">
                    <label>å¯¼å…¥åˆ°ç”¨æˆ· (å¯é€‰):</label>
                    <select id="importTargetUser" class="form-select">
                        <option value="">ä¿æŒåŸå½’å±</option>
                        <!-- ç”¨æˆ·åˆ—è¡¨å°†åŠ¨æ€å¡«å…… -->
                    </select>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('importModal')">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="importCredentials()">å¯¼å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼šå¯¼å‡ºå‡­è¯ -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“¦ å¯¼å‡ºå‡­è¯å¤‡ä»½</h3>
                <span class="close" onclick="closeModal('exportModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>å³å°†å¯¼å‡º <span id="exportCredCount" class="fw-bold">0</span> ä¸ªå‡­è¯</p>
                <div class="form-group mb-3">
                    <label>åŠ å¯†å¯†ç  (è‡³å°‘4ä½):</label>
                    <input type="password" id="exportPassword" class="form-control" placeholder="è®¾ç½®å¤‡ä»½å¯†ç ">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('exportModal')">å–æ¶ˆ</button>
                    <button class="btn btn-success" onclick="doExportCredentials()">å¯¼å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼šè¿ç§»å‡­è¯ -->
    <div id="migrateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â¡ï¸ è¿ç§»å‡­è¯</h3>
                <span class="close" onclick="closeModal('migrateModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>æ­£åœ¨è¿ç§»å‡­è¯: <span id="migrateFilename" class="fw-bold font-monospace"></span></p>
                <div class="form-group mb-3">
                    <label>ç›®æ ‡ç”¨æˆ·:</label>
                    <select id="migrateTargetUser" class="form-select">
                        <option value="global">Global (å…¬å…±)</option>
                        <!-- ç”¨æˆ·åˆ—è¡¨å°†åŠ¨æ€å¡«å…… -->
                    </select>
                </div>
                <div class="alert alert-warning small">
                    âš ï¸ è¿ç§»åï¼ŒåŸç”¨æˆ·å°†æ— æ³•è®¿é—®è¯¥å‡­è¯ï¼
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('migrateModal')">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="doMigrateCredential()">ç¡®è®¤è¿ç§»</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function getAuthHeaders() {
            const token = localStorage.getItem('gcli_token');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        async function checkAuth() {
            const token = localStorage.getItem('gcli_token');
            const role = localStorage.getItem('gcli_role');

            if (!token || role !== 'admin') {
                window.location.href = '/';
                return;
            }

            document.getElementById('currentUserDisplay').textContent = `ç®¡ç†å‘˜: ${localStorage.getItem('gcli_username') || 'Admin'}`;
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('åŠ è½½ç”¨æˆ·å¤±è´¥');

                const users = await response.json();
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';

                users.forEach(user => {
                    const tr = document.createElement('tr');
                    const createdDate = new Date(user.created_at * 1000).toLocaleString();
                    const statusBadge = user.disabled ? '<span class="badge bg-danger">ç¦ç”¨</span>' : '<span class="badge bg-success">æ­£å¸¸</span>';
                    tr.innerHTML = `
                        <td><small class="text-muted">${user.id}</small></td>
                        <td>${user.username}</td>
                        <td><span class="badge bg-${user.role === 'admin' ? 'danger' : 'info'} badge-role">${user.role}</span></td>
                        <td>${user.quota_daily === 0 ? 'æ— é™åˆ¶' : user.quota_daily}</td>
                        <td>${statusBadge}</td>
                        <td>${createdDate}</td>
                        <td>
                             <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="showResetPasswordModal('${user.id}', '${user.username}')">æ”¹å¯†</button>
                                <button class="btn btn-outline-info" onclick="showUserCredentials('${user.id}', '${user.username}')">å‡­è¯</button>
                                <button class="btn btn-outline-secondary" onclick="showUserUsage('${user.id}', '${user.username}')">ç»Ÿè®¡</button>
                                <button class="btn btn-outline-warning" onclick="showEditUserModal('${user.id}', '${user.username}', ${user.quota_daily}, ${user.disabled})">ç¼–è¾‘</button>
                                <button class="btn btn-outline-dark" onclick="impersonateUser('${user.id}', '${user.username}')">æ¨¡æ‹Ÿ</button>
                                <button class="btn btn-outline-danger" onclick="deleteUser('${user.id}', '${user.username}')">åˆ é™¤</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                alert(error.message);
            }
        }

        /* --- Modal & Action Functions --- */
        let currentUserId = null;

        function openModal(id) {
            document.getElementById(id).style.display = 'block';
            // Add dark mode class if body is dark mode
            if (document.body.classList.contains('dark-mode')) {
                document.getElementById(id).querySelector('.modal-content').classList.add('dark-mode');
            } else {
                document.getElementById(id).querySelector('.modal-content').classList.remove('dark-mode');
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }

        // --- Delete User ---
        async function deleteUser(userId, username) {
            if (username === 'admin') {
                alert('æ— æ³•åˆ é™¤é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·');
                return;
            }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');

                alert('ç”¨æˆ·å·²åˆ é™¤');
                loadUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        // --- Reset Password ---
        function showResetPasswordModal(userId, username) {
            currentUserId = userId;
            document.getElementById('resetPwdUsername').textContent = username;
            document.getElementById('adminNewPassword').value = '';
            openModal('resetPasswordModal');
        }

        async function confirmResetPassword() {
            if (!currentUserId) return;
            const newPassword = document.getElementById('adminNewPassword').value;
            if (!newPassword) {
                alert('è¯·è¾“å…¥æ–°å¯†ç ');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/${currentUserId}/password`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ new_password: newPassword })
                });

                if (!response.ok) throw new Error('é‡ç½®å¤±è´¥');

                alert('å¯†ç é‡ç½®æˆåŠŸ');
                closeModal('resetPasswordModal');
            } catch (error) {
                alert(error.message);
            }
        }

        // --- Edit User ---
        function showEditUserModal(userId, username, quotaDaily, isDisabled) {
            currentUserId = userId;
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUsername').value = username;
            document.getElementById('editQuotaDaily').value = quotaDaily;
            document.getElementById('editUserDisabled').checked = isDisabled;
            openModal('editUserModal');
        }

        async function saveUserStatus() {
            if (!currentUserId) return;
            const quotaDaily = parseInt(document.getElementById('editQuotaDaily').value);
            const isDisabled = document.getElementById('editUserDisabled').checked;

            if (isNaN(quotaDaily) || quotaDaily < 0) {
                alert('æ¯æ—¥é…é¢å¿…é¡»æ˜¯éè´Ÿæ•´æ•°');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/${currentUserId}/status`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        quota_daily: quotaDaily,
                        disabled: isDisabled
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'æ›´æ–°ç”¨æˆ·å¤±è´¥');
                }

                alert('ç”¨æˆ·è®¾ç½®å·²æ›´æ–°');
                closeModal('editUserModal');
                loadUsers(); // Refresh user list
            } catch (error) {
                alert(error.message);
            }
        }

        async function impersonateUser(userId, username) {
            if (!confirm(`ç¡®å®šè¦æ¨¡æ‹Ÿç”¨æˆ· "${username}" ç™»å½•å—ï¼Ÿ\nè¿™å°†ç”Ÿæˆä¸€ä¸ªä¸´æ—¶ Tokenã€‚`)) return;

            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/impersonate`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('æ¨¡æ‹Ÿç™»å½•å¤±è´¥');

                const result = await response.json();
                const token = result.token;

                // Show in a prompt for easy copying
                prompt(`æ¨¡æ‹Ÿç™»å½•æˆåŠŸï¼\nè¯·å¤åˆ¶ä»¥ä¸‹ Token ä½¿ç”¨ (User: ${username}):`, token);

            } catch (e) {
                alert(e.message);
            }
        }

        // --- View Credentials ---
        async function showUserCredentials(userId, username) {
            document.getElementById('viewCredsUsername').textContent = username;
            const listDiv = document.getElementById('credsList');
            listDiv.innerHTML = '<p>åŠ è½½ä¸­...</p>';
            openModal('viewCredsModal');

            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/credentials`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('åŠ è½½å‡­è¯å¤±è´¥');

                const creds = await response.json();
                if (creds.length === 0) {
                    listDiv.innerHTML = '<p class="text-muted">æ— å‡­è¯</p>';
                } else {
                    let html = '<ul class="list-group">';
                    creds.forEach(c => {
                        // Clean up filename display
                        const displayName = c.replace(`u_${userId}_`, '');
                        html += `<li class="list-group-item">${displayName} <small class="text-muted">(${c})</small></li>`;
                    });
                    html += '</ul>';
                    listDiv.innerHTML = html;
                }
            } catch (error) {
                listDiv.innerHTML = `<p class="text-danger">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // --- View Usage ---
        async function showUserUsage(userId, username) {
            document.getElementById('viewUsageUsername').textContent = username;
            const listDiv = document.getElementById('usageList');
            listDiv.innerHTML = '<p>åŠ è½½ä¸­...</p>';
            openModal('viewUsageModal');

            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/usage`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('åŠ è½½ç»Ÿè®¡å¤±è´¥');

                const usage = await response.json();
                const files = Object.keys(usage);

                if (files.length === 0) {
                    listDiv.innerHTML = '<div class="alert alert-secondary">è¯¥ç”¨æˆ·æš‚æ— ä½¿ç”¨è®°å½•</div>';
                } else {
                    const userStatsKey = `USER_stats_${userId}`;
                    let userDirectCalls = 0;
                    let credentialTotalCalls = 0;
                    let credentialFiles = [];

                    files.forEach(f => {
                        if (f === userStatsKey) {
                            userDirectCalls = (usage[f].calls_24h || 0);
                        } else {
                            credentialTotalCalls += (usage[f].calls_24h || 0);
                            credentialFiles.push(f);
                        }
                    });

                    // If userDirectCalls is present, use it. Otherwise fallback to credentialTotalCalls.
                    // Or prioritize showing "User Calls" if > 0.
                    const displayTotal = userDirectCalls > 0 ? userDirectCalls : credentialTotalCalls;
                    const isDirect = userDirectCalls > 0;

                    // Build Summary + Table
                    let html = `
                        <div class="stats-summary mb-3" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #0d6efd;">
                            <h5 style="margin: 0; color: #0d6efd;">ç”¨æˆ·å®é™…è°ƒç”¨ (24h): <strong>${displayTotal}</strong>${isDirect ? '' : ' (ä¼°ç®—)'}</h5>
                            <p style="margin: 5px 0 0; color: #6c757d; font-size: 0.9em;">
                                <span>å‡­è¯æ€»æ¶ˆè€—: ${credentialTotalCalls}</span> | 
                                <span>æ´»è·ƒå‡­è¯æ•°: ${credentialFiles.length}</span>
                            </p>
                        </div>
                        <h6 class="mb-2">å‡­è¯è¯¦ç»†è°ƒç”¨æƒ…å†µ:</h6>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th>å‡­è¯æ–‡ä»¶</th>
                                        <th style="width: 100px; text-align: right;">24hè°ƒç”¨</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                    if (credentialFiles.length === 0) {
                        html += `<tr><td colspan="2" class="text-muted text-center">æ— å‡­è¯ä½¿ç”¨è®°å½•</td></tr>`;
                    } else {
                        credentialFiles.forEach(f => {
                            const stats = usage[f];
                            const displayName = f.replace(`u_${userId}_`, '');
                            html += `
                                <tr>
                                    <td class="text-break" title="${f}">${displayName}</td>
                                    <td style="text-align: right; font-weight: bold;">${stats.calls_24h || 0}</td>
                                </tr>`;
                        });
                    }

                    html += '</tbody></table></div>';
                    listDiv.innerHTML = html;
                }
            } catch (error) {
                listDiv.innerHTML = `<div class="alert alert-danger">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/config/get`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('åŠ è½½é…ç½®å¤±è´¥');

                const data = await response.json();
                // æ³¨æ„ï¼šåç«¯è¿”å›ç»“æ„å¯èƒ½æ˜¯ {config: {...}, env_locked: [...]} æˆ–ç›´æ¥ {...}
                const config = data.config || data;

                document.getElementById('isolationMode').checked = config.credential_isolation_mode || false;

                // æ£€æŸ¥æ˜¯å¦è¢«ç¯å¢ƒå˜é‡é”å®š
                const locked = data.env_locked || [];
                if (locked.includes('credential_isolation_mode')) {
                    document.getElementById('isolationMode').disabled = true;
                    document.getElementById('isolationMode').parentElement.title = "ç”±ç¯å¢ƒå˜é‡æ§åˆ¶ï¼Œæ— æ³•ä¿®æ”¹";
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        async function saveConfig() {
            try {
                const isolationMode = document.getElementById('isolationMode').checked;

                const response = await fetch(`${API_BASE}/config/save`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        config: {
                            credential_isolation_mode: isolationMode
                        }
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'ä¿å­˜å¤±è´¥');
                }

                alert('é…ç½®å·²ä¿å­˜');
            } catch (error) {
                alert(error.message);
            }
        }

        // --- Unified Credential Management ---
        let allCredentialsData = [];

        async function loadAllCredentials() {
            const tbody = document.getElementById('allCredsTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">åŠ è½½ä¸­...</td></tr>';

            try {
                const response = await fetch(`${API_BASE}/admin/credentials/all`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('åŠ è½½å‡­è¯åˆ—è¡¨å¤±è´¥');

                allCredentialsData = await response.json();

                // Update total count
                document.getElementById('totalCredCount').innerText = allCredentialsData.length;
                document.getElementById('credentialCountBadge').innerText = allCredentialsData.length;

                // Initial Render
                filterCredentials();

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-danger">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
                console.error(error);
            }
        }

        function filterCredentials() {
            const searchInput = document.getElementById('credSearchInput').value.toLowerCase();
            const ownerFilter = document.getElementById('credOwnerFilter').value;
            const statusFilter = document.getElementById('credStatusFilter').value;

            const filteredData = allCredentialsData.filter(cred => {
                // Search Text
                const searchTextProps = [cred.filename, cred.owner].join(' ').toLowerCase();
                const matchesSearch = searchTextProps.includes(searchInput);

                // Owner Filter
                let matchesOwner = true;
                if (ownerFilter !== 'all') {
                    if (ownerFilter === 'Global') matchesOwner = (cred.owner === 'Global');
                    if (ownerFilter === 'User') matchesOwner = (cred.owner !== 'Global');
                }

                // Status Filter
                let matchesStatus = true;
                if (statusFilter !== 'all') {
                    if (statusFilter === 'disabled') matchesStatus = cred.disabled;
                    else if (statusFilter === 'error') matchesStatus = (!cred.disabled && cred.cooldown_until);
                    else if (statusFilter === 'healthy') matchesStatus = (!cred.disabled && !cred.cooldown_until);
                }

                return matchesSearch && matchesOwner && matchesStatus;
            });

            renderCredentialTable_Unified(filteredData);
        }

        function renderCredentialTable_Unified(data) {
            const tbody = document.getElementById('allCredsTableBody');
            tbody.innerHTML = '';
            document.getElementById('visibleCredCount').innerText = data.length;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æ— åŒ¹é…å‡­è¯</td></tr>';
                return;
            }

            data.forEach(c => {
                const tr = document.createElement('tr');

                // Status Badge
                let statusHtml = '';
                if (c.disabled) {
                    statusHtml += '<span class="badge bg-danger">ç¦ç”¨</span>';
                } else if (c.cooldown_until) {
                    const timeLeft = Math.max(0, Math.ceil(c.cooldown_until - Date.now() / 1000));
                    statusHtml += `<span class="badge bg-warning text-dark" title="å†·å´å‰©ä½™ ${timeLeft}s">å†·å´ä¸­</span>`;
                } else {
                    statusHtml += '<span class="badge bg-success">æ­£å¸¸</span>';
                }

                // Health Info
                let healthHtml = '<small class="text-secondary">-</small>';
                if (c.error_codes && c.error_codes.length > 0) {
                    const codes = c.error_codes.join(', ');
                    healthHtml = `<small class="text-danger" title="æœ€è¿‘é”™è¯¯ç : ${codes}">æŠ¥é”™ (${c.error_codes.length})</small>`;
                } else if (c.last_success) {
                    // Assuming last_success is timestamp? If not present, maybe healthy.
                    healthHtml = '<small class="text-success">è‰¯å¥½</small>';
                }

                // Last Success Formatting
                let lastSuccessTime = '-';
                if (c.last_success) {
                    try {
                        const date = new Date(c.last_success * 1000);
                        if (!isNaN(date.getTime())) {
                            lastSuccessTime = date.toLocaleString();
                        } else {
                            // Try direct isoformat
                            const date2 = new Date(c.last_success);
                            if (!isNaN(date2.getTime())) lastSuccessTime = date2.toLocaleString();
                        }
                    } catch (e) { }
                }

                tr.innerHTML = `
                    <td><input type="checkbox" class="cred-checkbox" data-filename="${c.filename}" onchange="updateCredSelection()"></td>
                    <td class="text-break" style="max-width: 200px;" title="${c.filename}"><small class="font-monospace">${c.filename}</small></td>
                    <td>${c.username ? c.username : c.owner}<br/><small class="text-muted font-monospace" style="font-size:0.7em">${c.owner_id || ''}</small><br/><small class="text-muted" style="font-size:0.65em">${c.user_email || ''}</small></td>
                    <td>${statusHtml}</td>
                    <td><div class="fw-bold">${c.calls_24h}</div></td>
                     <td>${healthHtml}</td>
                    <td><small class="text-muted">${lastSuccessTime}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn ${c.disabled ? 'btn-success' : 'btn-outline-warning'}" 
                                    onclick="toggleCredential('${c.filename}')" 
                                    title="${c.disabled ? 'å¯ç”¨' : 'ç¦ç”¨'}">
                                ${c.disabled ? 'âœ…' : 'ğŸš«'}
                            </button>
                            <button class="btn btn-outline-secondary" onclick="downloadCredential('${c.filename}')" title="ä¸‹è½½JSON">â¬‡</button>
                            <button class="btn btn-outline-info" onclick="openMigrateModal('${c.filename}')" title="è¿ç§»åˆ°å…¶ä»–ç”¨æˆ·">â¡ï¸</button>
                            <button class="btn btn-outline-danger" onclick="deleteCredential('${c.filename}')" title="æ°¸ä¹…åˆ é™¤">ğŸ—‘</button>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="openDebugModal('${c.filename}')" title="åœ¨çº¿è°ƒè¯•/æµ‹è¯•">ğŸ›  æµ‹è¯•</button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTrace('${c.filename}')" title="æŸ¥çœ‹è°ƒç”¨è¿½è¸ª">è¿½è¸ª</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function toggleCredential(filename) {
            try {
                const response = await fetch(`${API_BASE}/admin/credentials/${filename}/toggle`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('æ“ä½œå¤±è´¥');

                loadAllCredentials(); // Refresh list to update UI
            } catch (error) {
                alert(error.message);
            }
        }

        async function downloadCredential(filename) {
            try {
                const response = await fetch(`${API_BASE}/admin/credentials/${filename}/download`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('gcli_token')}` }
                });
                if (!response.ok) throw new Error('ä¸‹è½½å¤±è´¥');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert(error.message);
            }
        }

        async function deleteCredential(filename) {
            if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤å‡­è¯ "${filename}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) return;

            try {
                const response = await fetch(`${API_BASE}/admin/credentials/${filename}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');

                alert('å‡­è¯å·²åˆ é™¤');
                loadAllCredentials(); // Refresh list
            } catch (error) {
                alert(error.message);
            }
        }

        // --- Advanced Credential Operations ---
        let selectedCredentials = new Set();

        function updateCredSelection() {
            selectedCredentials.clear();
            document.querySelectorAll('.cred-checkbox:checked').forEach(cb => {
                selectedCredentials.add(cb.dataset.filename);
            });

            const count = selectedCredentials.size;
            document.getElementById('selectedCredCount').textContent = `å·²é€‰ ${count} é¡¹`;
            document.getElementById('btnBatchEnable').disabled = count === 0;
            document.getElementById('btnBatchDisable').disabled = count === 0;
            document.getElementById('btnBatchDelete').disabled = count === 0;
            document.getElementById('btnExportSelected').disabled = count === 0;

            // Sync header checkbox
            const allCheckboxes = document.querySelectorAll('.cred-checkbox');
            const allChecked = allCheckboxes.length > 0 && count === allCheckboxes.length;
            document.getElementById('selectAllCredsHeader').checked = allChecked;
            document.getElementById('selectAllCreds').checked = allChecked;
        }

        function toggleSelectAllCreds() {
            const isChecked = document.getElementById('selectAllCreds').checked ||
                document.getElementById('selectAllCredsHeader').checked;
            document.querySelectorAll('.cred-checkbox').forEach(cb => {
                cb.checked = isChecked;
            });
            updateCredSelection();
        }

        async function batchCredAction(action) {
            const count = selectedCredentials.size;
            if (count === 0) return;

            const actionNames = { enable: 'å¯ç”¨', disable: 'ç¦ç”¨', delete: 'åˆ é™¤' };
            if (!confirm(`ç¡®å®šè¦æ‰¹é‡${actionNames[action]} ${count} ä¸ªå‡­è¯å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`${API_BASE}/admin/creds/batch`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        action: action,
                        filenames: Array.from(selectedCredentials)
                    })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'æ“ä½œå¤±è´¥');

                alert(`æ‰¹é‡${actionNames[action]}å®Œæˆï¼æˆåŠŸ: ${result.success}, å¤±è´¥: ${result.failed}`);
                selectedCredentials.clear();
                loadAllCredentials();
            } catch (error) {
                alert(error.message);
            }
        }

        function exportSelectedCredentials() {
            if (selectedCredentials.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„å‡­è¯');
                return;
            }
            document.getElementById('exportCredCount').textContent = selectedCredentials.size;
            document.getElementById('exportPassword').value = '';
            openModal('exportModal');
        }

        async function doExportCredentials() {
            const password = document.getElementById('exportPassword').value;
            if (!password || password.length < 4) {
                alert('å¯†ç è‡³å°‘éœ€è¦4ä½');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/creds/export`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        filenames: Array.from(selectedCredentials),
                        password: password
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'å¯¼å‡ºå¤±è´¥');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `credentials_backup_${Date.now()}.gcli`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                closeModal('exportModal');
                alert('å¯¼å‡ºæˆåŠŸï¼è¯·å¦¥å–„ä¿ç®¡å¤‡ä»½æ–‡ä»¶å’Œå¯†ç ã€‚');
            } catch (error) {
                alert(error.message);
            }
        }

        async function openImportModal() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, { headers: getAuthHeaders() });
                if (response.ok) {
                    const users = await response.json();
                    const select = document.getElementById('importTargetUser');
                    select.innerHTML = '<option value="">ä¿æŒåŸå½’å±</option>';
                    users.forEach(u => {
                        select.innerHTML += `<option value="${u.id}">${u.username} (${u.id.substring(0, 8)}...)</option>`;
                    });
                }
            } catch (e) { console.error('Failed to load users', e); }

            document.getElementById('importFile').value = '';
            document.getElementById('importPassword').value = '';
            openModal('importModal');
        }

        async function importCredentials() {
            const fileInput = document.getElementById('importFile');
            const password = document.getElementById('importPassword').value;
            const targetUser = document.getElementById('importTargetUser').value;

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('è¯·é€‰æ‹©å¤‡ä»½æ–‡ä»¶');
                return;
            }
            if (!password) {
                alert('è¯·è¾“å…¥å¯†ç ');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('password', password);
            if (targetUser) formData.append('target_user_id', targetUser);

            try {
                const response = await fetch(`${API_BASE}/admin/creds/import`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('gcli_token')}` },
                    body: formData
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'å¯¼å…¥å¤±è´¥');

                closeModal('importModal');
                alert(`å¯¼å…¥æˆåŠŸï¼å·²å¯¼å…¥ ${result.imported} ä¸ªå‡­è¯ã€‚`);
                loadAllCredentials();
            } catch (error) {
                alert(error.message);
            }
        }

        let migrateTargetFilename = '';

        async function openMigrateModal(filename) {
            migrateTargetFilename = filename;
            document.getElementById('migrateFilename').textContent = filename;

            try {
                const response = await fetch(`${API_BASE}/admin/users`, { headers: getAuthHeaders() });
                if (response.ok) {
                    const users = await response.json();
                    const select = document.getElementById('migrateTargetUser');
                    select.innerHTML = '<option value="global">Global (å…¬å…±)</option>';
                    users.forEach(u => {
                        select.innerHTML += `<option value="${u.id}">${u.username} (${u.id.substring(0, 8)}...)</option>`;
                    });
                }
            } catch (e) { console.error('Failed to load users', e); }

            openModal('migrateModal');
        }

        async function doMigrateCredential() {
            const targetUser = document.getElementById('migrateTargetUser').value;
            if (!migrateTargetFilename) return;

            try {
                const response = await fetch(`${API_BASE}/admin/credentials/${encodeURIComponent(migrateTargetFilename)}/migrate`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ target_user_id: targetUser })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'è¿ç§»å¤±è´¥');

                closeModal('migrateModal');
                alert(`è¿ç§»æˆåŠŸï¼æ–°æ–‡ä»¶å: ${result.new_filename}`);
                loadAllCredentials();
            } catch (error) {
                alert(error.message);
            }
        }

        async function loadAnnouncement() {
            try {
                const response = await fetch(`${API_BASE}/announcement`, { headers: getAuthHeaders() });
                if (!response.ok) return;
                const data = await response.json();
                if (data && data.content) {
                    document.getElementById('announcementContent').value = data.content;
                    document.getElementById('announcementLevel').value = data.level || 'info';
                    document.getElementById('announcementEnabled').checked = data.enabled !== false;
                }
            } catch (e) {
                console.error('Failed to load announcement', e);
            }
        }

        async function publishAnnouncement() {
            const content = document.getElementById('announcementContent').value;
            const level = document.getElementById('announcementLevel').value;
            const enabled = document.getElementById('announcementEnabled').checked;

            try {
                const response = await fetch(`${API_BASE}/admin/announcement`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ content, level, enabled })
                });

                if (!response.ok) throw new Error('å‘å¸ƒå¤±è´¥');
                alert('å…¬å‘Šå·²æ›´æ–°');
            } catch (e) {
                alert(e.message);
            }
        }

        async function fetchLatencyStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats/latency`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const data = await response.json();
                    renderLatencyChart(data);
                }
            } catch (e) {
                console.error("Failed to fetch latency stats", e);
            }
        }

        let latencyChartInstance = null;

        function renderLatencyChart(data) {
            const ctx = document.getElementById('latencyChart').getContext('2d');
            if (latencyChartInstance) latencyChartInstance.destroy();
            latencyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'å¹³å‡å»¶è¿Ÿ (ms)',
                            data: data.avg_latency,
                            borderColor: '#36a2eb',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'P95 å»¶è¿Ÿ (ms)',
                            data: data.p95_latency,
                            borderColor: '#ff6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }





        // --- Upload Logic ---
        function openUploadModal() {
            document.getElementById('uploadCredModal').style.display = 'block';
            populateUserSelect();
        }

        function closeUploadModal() {
            document.getElementById('uploadCredModal').style.display = 'none';
            document.getElementById('uploadCredForm').reset();
        }

        async function populateUserSelect() {
            const select = document.getElementById('uploadTargetUser');
            // Keep first option (Global)
            select.innerHTML = '<option value="Global">Global (å…¨å±€å…±äº«)</option>';

            try {
                const response = await fetch(`${API_BASE}/admin/users`, { headers: getAuthHeaders() });
                if (response.ok) {
                    const users = await response.json();
                    users.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.id; // User ID
                        option.textContent = `User: ${u.username} (ID: ${u.id})`;
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error("Failed to load users for dropdown", e);
            }
        }

        async function submitUpload() {
            const fileInput = document.getElementById('uploadFile');
            const userSelect = document.getElementById('uploadTargetUser');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert("è¯·é€‰æ‹©æ–‡ä»¶");
                return;
            }

            const file = fileInput.files[0];
            const targetUserId = userSelect.value;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('target_user_id', targetUserId);

            try {
                const response = await fetch(`${API_BASE}/admin/credentials/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('gcli_token')}` }, // No Content-Type for FormData
                    body: formData
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'ä¸Šä¼ å¤±è´¥');
                }

                alert("ä¸Šä¼ æˆåŠŸ");
                closeUploadModal();
                loadAllCredentials(); // Refresh list
            } catch (e) {
                alert(e.message);
            }
        }

        function logout() {
            localStorage.removeItem('gcli_token');
            localStorage.removeItem('gcli_role');
            localStorage.removeItem('gcli_username');
            window.location.href = '/';
        }

        // --- Dark Mode Logic ---
        function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeButton(isDark);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
                updateThemeButton(true);
            } else {
                updateThemeButton(false);
            }
        }

        function updateThemeButton(isDark) {
            const btn = document.getElementById('themeToggleBtn');
            if (btn) btn.innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // åˆå§‹åŒ–
        loadTheme();
        checkAuth();
        loadUsers();
        loadConfig();
        loadAllCredentials(); // Updated to Unified View
        loadAnnouncement();
        loadDashboard();


        // --- Dashboard & Debug Logic ---
        let trafficChartInstance = null;
        let healthChartInstance = null;
        let currentDebugFile = null;

        async function loadDashboard() {
            // Fetch Trends
            try {
                const trendsRes = await fetch(`${API_BASE}/admin/stats/trends`, { headers: getAuthHeaders() });
                if (trendsRes.ok) {
                    const data = await trendsRes.json();
                    renderTrafficChart(data);
                }
            } catch (e) { console.error("Load trends failed", e); }

            // Fetch Health
            try {
                const healthRes = await fetch(`${API_BASE}/admin/stats/health`, { headers: getAuthHeaders() });
                if (healthRes.ok) {
                    const data = await healthRes.json();
                    renderHealthChart(data);
                }
            } catch (e) { console.error("Load health failed", e); }

            // Fetch Latency
            await fetchLatencyStats();

            // Fetch Errors
            await fetchErrorLogs();

            // Fetch Audit Logs
            await fetchAuditLogs();
        }

        let currentAuditPage = 1;
        const auditPageSize = 100;

        async function fetchAuditLogs(page = 1) {
            currentAuditPage = page;
            const tbody = document.getElementById('auditLogTableBody');

            // Get Filter Values
            const actionFilter = document.getElementById('auditActionFilter').value;
            const userFilter = document.getElementById('auditUserFilter').value.trim();
            const startDate = document.getElementById('auditStartDate').value;
            const endDate = document.getElementById('auditEndDate').value;

            tbody.innerHTML = '<tr><td colspan="5" class="text-center">åŠ è½½ä¸­...</td></tr>';

            // Action Mapping Configuration
            const ACTION_MAP = {
                'login': { text: 'ç™»å½•', class: 'bg-success' },
                'login_success': { text: 'ç™»å½•æˆåŠŸ', class: 'bg-success' },
                'login_failed': { text: 'ç™»å½•å¤±è´¥', class: 'bg-danger' },
                'upload_credential': { text: 'ä¸Šä¼ å‡­è¯', class: 'bg-primary' },
                'upload_credential_failed': { text: 'ä¸Šä¼ å¤±è´¥', class: 'bg-danger' },
                'delete_credential': { text: 'åˆ é™¤å‡­è¯', class: 'bg-warning text-dark' },
                'toggle_credential': { text: 'åˆ‡æ¢å‡­è¯', class: 'bg-info text-dark' },
                'download_credential': { text: 'ä¸‹è½½å‡­è¯', class: 'bg-secondary' },
                'update_user_status': { text: 'ç”¨æˆ·æ›´æ–°', class: 'bg-primary' },
                'impersonate_user': { text: 'æ¨¡æ‹Ÿç”¨æˆ·', class: 'bg-dark' },
            };

            try {
                // Build URL
                let url = `${API_BASE}/admin/audit_logs?page=${page}&limit=${auditPageSize}`;
                if (actionFilter) url += `&action=${actionFilter}`;
                if (userFilter) url += `&user_id=${encodeURIComponent(userFilter)}`;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;

                const response = await fetch(url, { headers: getAuthHeaders() });
                if (response.ok) {
                    const data = await response.json();
                    // Handle both new format {total, items} and legacy list
                    const logs = Array.isArray(data) ? data : (data.items || []);
                    const total = data.total || logs.length;

                    updateAuditPagination(total);

                    tbody.innerHTML = '';

                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— å®¡è®¡è®°å½•</td></tr>';
                        return;
                    }

                    logs.forEach(log => {
                        const tr = document.createElement('tr');
                        const date = new Date(log.timestamp * 1000).toLocaleString('zh-CN', { hour12: false });

                        // Resolve Action Badge
                        const actionConf = ACTION_MAP[log.action] || { text: log.action, class: 'bg-secondary' };

                        // Format Details
                        let detailsHtml = '-';
                        if (log.details && Object.keys(log.details).length > 0) {
                            detailsHtml = Object.entries(log.details)
                                .map(([k, v]) => {
                                    // Handle nested objects
                                    let valStr = (typeof v === 'object' && v !== null) ? JSON.stringify(v) : String(v);
                                    // Truncate long values
                                    if (valStr.length > 50) valStr = valStr.substring(0, 50) + '...';
                                    return `<span class="text-muted small">${k}:</span> <span class="text-break">${valStr}</span>`;
                                })
                                .join('<br>');
                        }

                        // Format User ID (Show username + ID)
                        let userDisplay = '';
                        if (log.user_id === 'unknown') {
                            userDisplay = '<span class="text-muted">æœªçŸ¥</span>';
                        } else if (log.username) {
                            userDisplay = `<span class="fw-bold">${log.username}</span><br/><span class="text-muted font-monospace small">${log.user_id}</span>`;
                        } else {
                            userDisplay = `<span class="text-break font-monospace small">${log.user_id}</span>`;
                        }

                        tr.innerHTML = `
                            <td style="white-space: nowrap;">${date}</td>
                            <td><span class="badge ${actionConf.class}">${actionConf.text}</span></td>
                            <td>${userDisplay}</td>
                            <td><small>${log.ip}</small></td>
                            <td class="small" style="line-height: 1.4;">${detailsHtml}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="5" class="text-danger">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
            }
        }

        function updateAuditPagination(total) {
            const start = (currentAuditPage - 1) * auditPageSize + 1;
            const end = Math.min(start + auditPageSize - 1, total);
            const totalPages = Math.ceil(total / auditPageSize);

            document.getElementById('auditLogInfo').innerText =
                total > 0 ? `æ˜¾ç¤º ${start}-${end} æ¡ï¼Œå…± ${total} æ¡` : 'æ— è®°å½•';

            document.getElementById('auditPageBtn').innerText = currentAuditPage;
            document.getElementById('auditPrevBtn').disabled = currentAuditPage <= 1;
            document.getElementById('auditNextBtn').disabled = currentAuditPage >= totalPages;
        }

        function changeAuditPage(delta) {
            fetchAuditLogs(currentAuditPage + delta);
        }

        async function exportAuditLogs() {
            const actionFilter = document.getElementById('auditActionFilter').value;
            const userFilter = document.getElementById('auditUserFilter').value.trim();
            const startDate = document.getElementById('auditStartDate').value;
            const endDate = document.getElementById('auditEndDate').value;

            let url = `${API_BASE}/admin/audit_logs/export?`;
            if (actionFilter) url += `action=${actionFilter}&`;
            if (userFilter) url += `user_id=${encodeURIComponent(userFilter)}&`;
            if (startDate) url += `start_date=${startDate}&`;
            if (endDate) url += `end_date=${endDate}`;

            try {
                const response = await fetch(url, { headers: getAuthHeaders() });
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `audit_logs_${new Date().toISOString().slice(0, 10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                } else {
                    const errorText = await response.text();
                    alert(`å¯¼å‡ºå¤±è´¥ (${response.status}): ${errorText}`);
                }
            } catch (e) {
                alert('å¯¼å‡ºå‡ºé”™: ' + e.message);
            }
        }

        async function fetchErrorLogs() {
            const tbody = document.getElementById('errorLogTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">åŠ è½½ä¸­...</td></tr>';

            try {
                const response = await fetch(`${API_BASE}/admin/stats/errors?limit=50`, { headers: getAuthHeaders() });
                if (response.ok) {
                    const logs = await response.json();
                    tbody.innerHTML = '';

                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— æŠ¥é”™è®°å½•</td></tr>';
                        return;
                    }

                    logs.forEach(log => {
                        const tr = document.createElement('tr');
                        const date = new Date(log.timestamp * 1000).toLocaleString();
                        tr.innerHTML = `
                            <td>${date}</td>
                            <td class="text-break" style="max-width: 150px;">${log.credential}</td>
                            <td>${log.user_id}</td>
                            <td><span class="badge ${log.status_code >= 500 ? 'bg-danger' : 'bg-warning'}">${log.status_code}</span></td>
                            <td class="text-break" style="max-width: 400px;">${log.error_msg}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-danger">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
            }
        }

        function renderTrafficChart(data) {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            if (trafficChartInstance) trafficChartInstance.destroy();
            trafficChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'API Calls',
                        data: data.data,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: true,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        let ownershipChartInstance = null;

        function renderHealthChart(stats) {
            // Unpack stats (now nested)
            const health = stats.health_stats || {};
            const ownership = stats.ownership_stats || {};

            // Render Health Chart
            const ctxH = document.getElementById('healthChart').getContext('2d');
            if (healthChartInstance) healthChartInstance.destroy();
            healthChartInstance = new Chart(ctxH, {
                type: 'doughnut',
                data: {
                    labels: ['å¥åº·', 'æŠ¥é”™', 'ç¦ç”¨'],
                    datasets: [{
                        data: [health.healthy, health.error, health.disabled],
                        backgroundColor: ['#198754', '#ffc107', '#6c757d']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Render Ownership Chart
            const ctxO = document.getElementById('ownershipChart').getContext('2d');
            if (ownershipChartInstance) ownershipChartInstance.destroy();
            ownershipChartInstance = new Chart(ctxO, {
                type: 'pie',
                data: {
                    labels: ['ç”¨æˆ·å‡­è¯', 'å…¨å±€å‡­è¯'],
                    datasets: [{
                        data: [ownership.user, ownership.global],
                        backgroundColor: ['#6610f2', '#0dcaf0']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function openDebugModal(filename) {
            currentDebugFile = filename;
            document.getElementById('debugTargetName').innerText = filename;
            document.getElementById('debugOutput').innerText = "ç­‰å¾…æµ‹è¯•æŒ‡ä»¤...\n(ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•)";
            document.getElementById('debugStatus').className = 'float-end badge me-2 bg-secondary';
            document.getElementById('debugStatus').innerText = 'Status: -';
            document.getElementById('debugLatency').innerText = 'Latency: -';
            openModal('debugModal');
        }

        function closeDebugModal() {
            closeModal('debugModal');
        }

        async function runDebugTest() {
            if (!currentDebugFile) return;
            const output = document.getElementById('debugOutput');
            output.innerText = "Sending request to Google API via Proxy...";

            const selectedModel = document.getElementById('testModelSelect').value;
            try {
                const response = await fetch(`${API_BASE}/admin/credentials/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                    body: JSON.stringify({ filename: currentDebugFile, model: selectedModel })
                });

                const result = await response.json();

                document.getElementById('debugLatency').innerText = `Latency: ${result.latency || '-'}`;
                const statusBadge = document.getElementById('debugStatus');
                statusBadge.innerText = `Status: ${result.status || response.status}`;
                statusBadge.className = `float-end badge me-2 bg-${result.success ? 'success' : 'danger'}`;

                output.innerText = result.log || JSON.stringify(result, null, 2);
            } catch (e) {
                output.innerText = `Error: ${e.message}`;
            }
        }

        // --- View Trace ---
        async function viewTrace(filename) {
            document.getElementById('traceTargetName').innerText = filename;
            const tbody = document.getElementById('traceTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">åŠ è½½ä¸­...</td></tr>';
            openModal('traceModal');

            try {
                const response = await fetch(`${API_BASE}/admin/credentials/${filename}/trace?limit=50`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const logs = await response.json();
                    tbody.innerHTML = '';
                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">æš‚æ— è°ƒç”¨è®°å½•</td></tr>';
                        return;
                    }

                    logs.forEach(log => {
                        const tr = document.createElement('tr');
                        const date = new Date(log.timestamp * 1000).toLocaleString();
                        const statusClass = log.status_code === 200 ? 'success' : 'danger';
                        tr.innerHTML = `
                            <td>${date}</td>
                            <td>${log.user_id}</td>
                            <td>${log.model}</td>
                            <td>${log.latency} ms</td>
                            <td><span class="badge bg-${statusClass}">${log.status_code}</span></td>
                            <td><small class="text-muted" title="${log.error || ''}">${log.error ? log.error.substring(0, 30) + '...' : '-'}</small></td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    throw new Error('åŠ è½½å¤±è´¥');
                }
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-danger">Error: ${e.message}</td></tr>`;
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const debugModal = document.getElementById('debugModal');
            const uploadModal = document.getElementById('uploadCredModal');
            const resetPasswordModal = document.getElementById('resetPasswordModal');
            const viewCredsModal = document.getElementById('viewCredsModal');
            const viewUsageModal = document.getElementById('viewUsageModal');
            const editUserModal = document.getElementById('editUserModal');
            const traceModal = document.getElementById('traceModal');

            if (event.target == debugModal) {
                debugModal.style.display = "none";
            }
            if (event.target == uploadModal) {
                uploadModal.style.display = "none";
            }
            if (event.target == resetPasswordModal) {
                resetPasswordModal.style.display = "none";
            }
            if (event.target == viewCredsModal) {
                viewCredsModal.style.display = "none";
            }
            if (event.target == viewUsageModal) {
                viewUsageModal.style.display = "none";
            }
            if (event.target == editUserModal) {
                editUserModal.style.display = "none";
            }
            if (event.target == traceModal) {
                traceModal.style.display = "none";
            }
        }
    </script>
    <!-- Debug Modal -->
    <div id="debugModal" class="modal">
        <div class="modal-content" style="width: 70%; max-width: 800px;">
            <div class="modal-header">
                <h5>å‡­è¯è°ƒè¯•æ§åˆ¶å°</h5>
                <span class="close" onclick="closeDebugModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label>æµ‹è¯•å‡­è¯: <span id="debugTargetName" class="fw-bold"></span></label>
                </div>
                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©æµ‹è¯•æ¨¡å‹:</label>
                    <select id="testModelSelect" class="form-select">
                        <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                        <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                        <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
                    </select>
                </div>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-primary" onclick="runDebugTest()">â–¶ å‘èµ·æµ‹è¯•è¯·æ±‚ (Hello World)</button>
                </div>
                <div class="card bg-dark text-light">
                    <div class="card-header border-secondary">
                        è°ƒè¯•æ—¥å¿—
                        <span id="debugLatency" class="float-end badge bg-secondary">Latency: -</span>
                        <span id="debugStatus" class="float-end badge me-2 bg-secondary">Status: -</span>
                    </div>
                    <div class="card-body font-monospace"
                        style="height: 300px; overflow-y: auto; white-space: pre-wrap;" id="debugOutput">ç­‰å¾…æµ‹è¯•æŒ‡ä»¤...</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Upload Modal -->
    <div id="uploadCredModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>ä¸Šä¼ å‡­è¯ (JSON)</h5>
                <span class="close" onclick="closeUploadModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="uploadCredForm">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©å‡­è¯æ–‡ä»¶ (.json)</label>
                        <input type="file" id="uploadFile" class="form-control" accept=".json" required>
                        <div class="form-text">æ”¯æŒ Google Service Account Key JSON æ–‡ä»¶ã€‚</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å½’å±ç”¨æˆ·</label>
                        <select id="uploadTargetUser" class="form-select">
                            <option value="Global">Global (å…¨å±€å…±äº«)</option>
                            <!-- Users will be populated here -->
                        </select>
                        <div class="form-text">"Global" è¡¨ç¤ºæ‰€æœ‰ç”¨æˆ·å¯ç”¨ï¼ˆé™¤éå¼€å¯éš”ç¦»æ¨¡å¼ï¼‰ã€‚æŒ‡å®šç”¨æˆ·åˆ™ä»…è¯¥ç”¨æˆ·å¯ç”¨ã€‚</div>
                    </div>
                </form>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeUploadModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="submitUpload()">ä¸Šä¼ </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>ç¼–è¾‘ç”¨æˆ·</h5>
                <span class="close" onclick="closeModal('editUserModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="form-control" id="editUsername" readonly disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ¯æ—¥é…é¢ (0 = æ— é™åˆ¶)</label>
                        <input type="number" class="form-control" id="editQuotaDaily" min="0">
                    </div>
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="editUserDisabled">
                        <label class="form-check-label" for="editUserDisabled">ç¦ç”¨è´¦æˆ· (Ban)</label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary"
                            onclick="closeModal('editUserModal')">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" onclick="saveUserStatus()">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>

    <!-- Trace Modal -->
    <div id="traceModal" class="modal">
        <div class="modal-content" style="width: 80%;">
            <div class="modal-header">
                <h5>è°ƒç”¨è¿½è¸ª: <span id="traceTargetName"></span></h5>
                <span class="close" onclick="closeModal('traceModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-sm table-hover small">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>ç”¨æˆ·</th>
                                <th>æ¨¡å‹</th>
                                <th>å»¶è¿Ÿ</th>
                                <th>çŠ¶æ€</th>
                                <th>é”™è¯¯</th>
                            </tr>
                        </thead>
                        <tbody id="traceTableBody">
                            <!-- Logs -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>

</html>